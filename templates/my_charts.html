{% extends "base.html" %}

{% block title %}My Charts - YieldLife{% endblock %}

{% block extra_css %}
<style>
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }
    .chart-card {
        background: radial-gradient(ellipse at center, #ddd6b9 60%, #79cf55 100%);
        border: 3px solid #1f201f;
        border-radius: 16px;
        padding: 1.5rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .chart-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(31, 32, 31, 0.15);
    }
    .chart-name {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--carbon-black);
    }
    .chart-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .filter-badge {
        background: rgba(14, 135, 73, 0.15);
        color: var(--sea-green);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .chart-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }
    .chart-actions {
        display: flex;
        gap: 0.5rem;
    }
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    .login-prompt {
        text-align: center;
        padding: 4rem 2rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        max-width: 500px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">My Saved Charts</h1>
    
    {% if current_user.is_authenticated %}
    <div id="chartsContainer">
        <div class="text-center py-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
    {% else %}
    <div class="login-prompt">
        <div class="empty-state-icon">ðŸ”’</div>
        <h3>Login Required</h3>
        <p class="text-muted mb-4">Please log in to view and manage your saved charts.</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#authModal">
            Login / Sign Up
        </button>
    </div>
    {% endif %}
</div>

<!-- Edit Chart Modal -->
<div class="modal fade" id="editChartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Chart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editChartForm">
                    <input type="hidden" id="editChartId">
                    <div class="mb-3">
                        <label for="editChartName" class="form-label">Chart Name</label>
                        <input type="text" class="form-control" id="editChartName" required maxlength="100">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if current_user.is_authenticated %}
<script>
let charts = [];

async function loadCharts() {
    try {
        const response = await fetch('/api/auth/charts');
        charts = await response.json();
        renderCharts();
    } catch (e) {
        console.error('Error loading charts:', e);
        document.getElementById('chartsContainer').innerHTML = `
            <div class="alert alert-danger">Failed to load charts. Please try again.</div>
        `;
    }
}

function renderCharts() {
    const container = document.getElementById('chartsContainer');
    
    if (charts.length === 0) {
        container.innerHTML = `
            <div class="empty-state card p-5">
                <div class="empty-state-icon">ðŸ“Š</div>
                <h3>No Saved Charts</h3>
                <p class="text-muted mb-4">You haven't saved any charts yet. Browse yields and save your favorite views!</p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="/lps" class="btn btn-primary">Browse LPs</a>
                    <a href="/earn" class="btn btn-outline-primary">View Earn Rates</a>
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `<div class="charts-grid">${charts.map(renderChartCard).join('')}</div>`;
}

function renderChartCard(chart) {
    const filters = chart.filters || {};
    const created = new Date(chart.created_at).toLocaleDateString();
    
    // Build filter badges
    let badges = [];
    if (filters.chain) badges.push(`<span class="filter-badge">${filters.chain}</span>`);
    if (filters.protocol) badges.push(`<span class="filter-badge">${filters.protocol}</span>`);
    if (filters.yield_type) badges.push(`<span class="filter-badge">${filters.yield_type}</span>`);
    if (filters.assets && filters.assets.length) {
        badges.push(`<span class="filter-badge">${filters.assets.length} assets</span>`);
    }
    if (filters.days) badges.push(`<span class="filter-badge">${filters.days}d</span>`);
    
    // Build URL to load chart
    let chartUrl = '/';
    if (filters.chain && filters.yield_type === 'lp') {
        chartUrl = `/chain/${filters.chain}`;
    } else if (filters.yield_type === 'lp') {
        chartUrl = '/lps';
    } else if (filters.yield_type === 'supply') {
        chartUrl = '/earn';
    } else if (filters.yield_type === 'borrow') {
        chartUrl = '/borrow';
    } else if (filters.chain) {
        chartUrl = `/chain/${filters.chain}`;
    }
    
    return `
        <div class="chart-card" data-chart-id="${chart.chart_id}">
            <div class="chart-name">${escapeHtml(chart.name)}</div>
            <div class="chart-filters">${badges.join('')}</div>
            <div class="chart-meta">Created: ${created}</div>
            <div class="chart-actions">
                <a href="${chartUrl}" class="btn btn-sm btn-primary">View</a>
                <button class="btn btn-sm btn-outline-secondary" onclick="editChart(${chart.chart_id})">Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteChart(${chart.chart_id})">Delete</button>
            </div>
        </div>
    `;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function editChart(chartId) {
    const chart = charts.find(c => c.chart_id === chartId);
    if (!chart) return;
    
    document.getElementById('editChartId').value = chartId;
    document.getElementById('editChartName').value = chart.name;
    new bootstrap.Modal(document.getElementById('editChartModal')).show();
}

document.getElementById('editChartForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const chartId = document.getElementById('editChartId').value;
    const name = document.getElementById('editChartName').value;
    
    try {
        const response = await fetch(`/api/auth/charts/${chartId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editChartModal')).hide();
            loadCharts();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update chart');
        }
    } catch (e) {
        alert('Failed to update chart');
    }
});

async function deleteChart(chartId) {
    if (!confirm('Are you sure you want to delete this chart?')) return;
    
    try {
        const response = await fetch(`/api/auth/charts/${chartId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadCharts();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to delete chart');
        }
    } catch (e) {
        alert('Failed to delete chart');
    }
}

// Load charts on page load
loadCharts();
</script>
{% endif %}
{% endblock %}

