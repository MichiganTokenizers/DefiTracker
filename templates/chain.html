{% extends "base.html" %}

{% block title %}{{ chain|title }} - DeFi APR Tracker{% endblock %}

{% block extra_css %}
<style>
    #aprTable {
        margin-bottom: 0;
    }
    #aprTable th {
        border-top: none;
        border-bottom: 2px solid rgba(255,255,255,0.2);
        padding: 1rem;
        font-weight: 600;
        color: #b0b3c1;
        user-select: none;
    }
    #aprTable th:hover {
        color: #ffffff;
    }
    #aprTable td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    #aprTable tbody tr:hover {
        background-color: rgba(255,255,255,0.05);
    }
    .table-responsive {
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="display-6">
            <span class="chain-badge chain-{{ chain }}">{{ chain|upper }}</span>
            {{ chain|title }} APR History
        </h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <label class="form-label">Time Range</label>
        <select id="timeRange" class="form-select">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last Year</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Asset Filter</label>
        <select id="assetFilter" class="form-select">
            <option value="">All Assets</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Chart Type</label>
        <select id="chartType" class="form-select">
            <option value="line">Line Chart</option>
            <option value="bar">Bar Chart</option>
        </select>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card p-4" style="min-height: 600px;">
            <canvas id="aprChart"></canvas>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card p-4">
            <h5 class="mb-3">Current APRs</h5>
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="aprTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable(0)" id="th-0">Asset</th>
                            <th style="cursor: pointer;" onclick="sortTable(1)" id="th-1">Current APR</th>
                            <th style="cursor: pointer;" onclick="sortTable(2)" id="th-2">24h Change ↓</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="currentAprs">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chain = "{{ chain }}";
let chart = null;
let currentSortColumn = 2; // Default to 24h Change column
let currentSortDirection = 'desc'; // Default to descending

// Get protocol name based on chain
const protocolMap = {
    'flare': 'kinetic',
    'cardano': 'minswap'
};
const protocol = protocolMap[chain];

async function loadAssets() {
    const response = await fetch(`/api/${chain}/${protocol}/assets`);
    const assets = await response.json();
    
    const select = document.getElementById('assetFilter');
    assets.forEach(asset => {
        const option = document.createElement('option');
        option.value = asset.symbol;
        option.textContent = asset.symbol + (asset.name ? ` (${asset.name})` : '');
        select.appendChild(option);
    });
}

async function loadChart() {
    const days = document.getElementById('timeRange').value;
    const asset = document.getElementById('assetFilter').value;
    const chartType = document.getElementById('chartType').value;
    
    const url = `/api/${chain}/${protocol}/history?days=${days}${asset ? '&asset=' + asset : ''}`;
    const response = await fetch(url);
    const data = await response.json();
    
    // Destroy existing chart
    if (chart) {
        chart.destroy();
    }
    
    // Prepare datasets
    const datasets = data.map((assetData, idx) => {
        const colors = [
            '#4ade80', '#60a5fa', '#f59e0b', '#ef4444', '#a78bfa',
            '#ec4899', '#14b8a6', '#f97316', '#8b5cf6', '#06b6d4'
        ];
        const color = colors[idx % colors.length];
        
        return {
            label: assetData.symbol,
            data: assetData.data.map(d => ({
                x: new Date(d.timestamp),
                y: d.apr
            })),
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.4,
            fill: chartType === 'line'
        };
    });
    
    // Create chart
    const ctx = document.getElementById('aprChart').getContext('2d');
    chart = new Chart(ctx, {
        type: chartType,
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: days <= 7 ? 'day' : days <= 30 ? 'day' : 'week'
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#b0b3c1' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: {
                        color: '#b0b3c1',
                        callback: (value) => value + '%'
                    }
                }
            }
        }
    });
    
    // Update current APRs table
    updateCurrentAprs(data);
}

function updateCurrentAprs(data) {
    const tbody = document.getElementById('currentAprs');
    tbody.innerHTML = '';
    
    // Sort by APR descending
    const sortedData = data.map(assetData => {
        const latest = assetData.data[assetData.data.length - 1];
        if (!latest) return null;
        
        // Calculate 24h change if we have data from ~24h ago
        let change24h = null;
        if (assetData.data.length > 1) {
            const now = new Date(latest.timestamp);
            const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
            
            // Find closest data point to 24h ago
            let closest = assetData.data[0];
            let minDiff = Math.abs(new Date(closest.timestamp) - oneDayAgo);
            
            for (let point of assetData.data) {
                const diff = Math.abs(new Date(point.timestamp) - oneDayAgo);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = point;
                }
            }
            
            change24h = latest.apr - closest.apr;
        }
        
        return {
            symbol: assetData.symbol,
            apr: latest.apr,
            change24h: change24h,
            timestamp: new Date(latest.timestamp)
        };
    }).filter(x => x !== null);
    
    // Store data globally for sorting
    window.tableData = sortedData;
    
    // Apply initial sort
    applySortToTable();
}

function applySortToTable() {
    const tbody = document.getElementById('currentAprs');
    tbody.innerHTML = '';
    
    // Sort the data based on current column and direction
    let sorted = [...window.tableData];
    
    sorted.sort((a, b) => {
        let aVal, bVal;
        
        switch(currentSortColumn) {
            case 0: // Asset
                aVal = a.symbol;
                bVal = b.symbol;
                const cmp = aVal.localeCompare(bVal);
                return currentSortDirection === 'asc' ? cmp : -cmp;
            
            case 1: // APR
                aVal = a.apr;
                bVal = b.apr;
                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            
            case 2: // 24h Change
                aVal = a.change24h ?? -Infinity;
                bVal = b.change24h ?? -Infinity;
                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            
            default:
                return 0;
        }
    });
    
    // Update column headers with arrows
    for (let i = 0; i < 3; i++) {
        const th = document.getElementById(`th-${i}`);
        if (th) {
            let text = th.textContent.replace(/ [↑↓]/g, '');
            if (i === currentSortColumn) {
                text += currentSortDirection === 'asc' ? ' ↑' : ' ↓';
            }
            th.textContent = text;
        }
    }
    
    // Populate table
    sorted.forEach(item => {
        const row = document.createElement('tr');
        
        // Format 24h change
        let changeHtml = '<span class="text-muted">-</span>';
        if (item.change24h !== null) {
            const changeClass = item.change24h >= 0 ? 'text-success' : 'text-danger';
            const changeSymbol = item.change24h >= 0 ? '+' : '';
            changeHtml = `<span class="${changeClass}">${changeSymbol}${item.change24h.toFixed(2)}%</span>`;
        }
        
        // Format timestamp
        const timeAgo = formatTimeAgo(item.timestamp);
        
        row.innerHTML = `
            <td><strong>${item.symbol}</strong></td>
            <td><span style="color: #4ade80; font-size: 1.1rem; font-weight: 600;">${item.apr.toFixed(2)}%</span></td>
            <td>${changeHtml}</td>
            <td class="text-secondary">${timeAgo}</td>
        `;
        tbody.appendChild(row);
    });
}

function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
}

function sortTable(columnIndex) {
    // Toggle direction if clicking the same column, otherwise default to desc
    if (currentSortColumn === columnIndex) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = columnIndex;
        currentSortDirection = 'desc';
    }
    
    applySortToTable();
}

// Event listeners
document.getElementById('timeRange').addEventListener('change', loadChart);
document.getElementById('assetFilter').addEventListener('change', loadChart);
document.getElementById('chartType').addEventListener('change', loadChart);

// Initial load
loadAssets().then(loadChart);
</script>
{% endblock %}

