{% extends "base.html" %}

{% block title %}{{ chain|title }} - DeFi APR Tracker{% endblock %}

{% block extra_css %}
<style>
    #aprTable {
        margin-bottom: 0;
    }
    #aprTable th {
        border-top: none;
        border-bottom: 2px solid rgba(255,255,255,0.2);
        padding: 1rem;
        font-weight: 600;
        color: #b0b3c1;
        user-select: none;
    }
    #aprTable th:hover {
        color: #ffffff;
    }
    #aprTable td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    #aprTable tbody tr:hover {
        background-color: rgba(255,255,255,0.05);
    }
    .table-responsive {
        border-radius: 8px;
    }
    
    /* Multi-select dropdown styles */
    .multi-select-container {
        position: relative;
    }
    .multi-select-btn {
        width: 100%;
        text-align: left;
        background: var(--bg-card);
        border: 1px solid rgba(255,255,255,0.15);
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .multi-select-btn:hover {
        border-color: rgba(255,255,255,0.3);
    }
    .multi-select-btn .count-badge {
        background: var(--accent-primary);
        color: #000;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 6px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .multi-select-dropdown.show {
        display: block;
    }
    .multi-select-actions {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .multi-select-actions button {
        flex: 1;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
        border: 1px solid rgba(255,255,255,0.2);
        background: transparent;
        color: #b0b3c1;
        cursor: pointer;
    }
    .multi-select-actions button:hover {
        background: rgba(255,255,255,0.1);
        color: #fff;
    }
    .multi-select-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.15s;
    }
    .multi-select-option:hover {
        background: rgba(255,255,255,0.05);
    }
    .multi-select-option input {
        margin-right: 10px;
        accent-color: var(--accent-primary);
    }
    .multi-select-option label {
        cursor: pointer;
        margin: 0;
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="display-6">
            <span class="chain-badge chain-{{ chain }}">{{ chain|upper }}</span>
            {{ chain|title }} APR History
        </h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <label class="form-label">Time Range</label>
        <select id="timeRange" class="form-select">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last Year</option>
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Asset Filter</label>
        <div class="multi-select-container" id="assetFilterContainer">
            <button type="button" class="multi-select-btn" id="assetFilterBtn">
                <span id="assetFilterLabel">Loading...</span>
                <span class="count-badge" id="assetCount">0</span>
            </button>
            <div class="multi-select-dropdown" id="assetDropdown">
                <div class="multi-select-actions">
                    <button type="button" onclick="selectAllAssets()">Select All</button>
                    <button type="button" onclick="deselectAllAssets()">Clear</button>
                    <button type="button" onclick="selectDefaults()">Defaults</button>
                </div>
                <div id="assetOptions">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card p-4" style="height: 700px;">
            <canvas id="aprChart"></canvas>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card p-4">
            <h5 class="mb-3">Current APRs</h5>
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="aprTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable(0)" id="th-0">Asset</th>
                            <th style="cursor: pointer;" onclick="sortTable(1)" id="th-1">Current APR ↓</th>
                            <th style="cursor: pointer;" onclick="sortTable(2)" id="th-2">24h Change</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="currentAprs">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chain = "{{ chain }}";
let chart = null;
let currentSortColumn = 1; // Default to Current APR column
let currentSortDirection = 'asc'; // Default to ascending (lowest first)
let allAssets = [];
let selectedAssets = new Set();

// Get protocol name based on chain
const protocolMap = {
    'flare': 'kinetic',
    'cardano': 'minswap'
};
const protocol = protocolMap[chain];

// Protocol logo mapping
const protocolLogos = {
    'kinetic': '/static/kinetic-logo.svg',
    'minswap': '/static/minswap-logo.webp'
};
const protocolLogo = protocolLogos[protocol];

// Default asset selections by chain
const defaultAssets = {
    'cardano': [
        // NIGHT pairs
        'NIGHT-ADA', 'NIGHT-USDM', 'NIGHT-USDA',
        // ADA/stablecoin pairs  
        'USDM/ADA', 'USDA/ADA', 'DJED/ADA', 'iUSD/ADA',
        // Other key pairs
        'MIN/ADA', 'SNEK/ADA'
    ],
    'flare': [
        // FXRP and stablecoin supply returns
        'FXRP', 'USDT0', 'USDT', 'USDC', 'USDC.e', 'stXRP'
    ]
};

function isDefaultAsset(symbol) {
    const defaults = defaultAssets[chain] || [];
    // Check exact match or partial match for flexibility
    return defaults.some(d => 
        symbol === d || 
        symbol.toUpperCase() === d.toUpperCase() ||
        symbol.includes(d) || 
        d.includes(symbol)
    );
}

async function loadAssets() {
    const response = await fetch(`/api/${chain}/${protocol}/assets`);
    allAssets = await response.json();
    
    const optionsContainer = document.getElementById('assetOptions');
    optionsContainer.innerHTML = '';
    
    allAssets.forEach(asset => {
        const isDefault = isDefaultAsset(asset.symbol);
        if (isDefault) {
            selectedAssets.add(asset.symbol);
        }
        
        const div = document.createElement('div');
        div.className = 'multi-select-option';
        div.innerHTML = `
            <input type="checkbox" id="asset-${asset.symbol}" value="${asset.symbol}" 
                   ${isDefault ? 'checked' : ''} onchange="toggleAsset('${asset.symbol}')">
            <label for="asset-${asset.symbol}">${asset.symbol}</label>
        `;
        optionsContainer.appendChild(div);
    });
    
    updateAssetLabel();
}

function toggleAsset(symbol) {
    if (selectedAssets.has(symbol)) {
        selectedAssets.delete(symbol);
    } else {
        selectedAssets.add(symbol);
    }
    updateAssetLabel();
    loadChart();
}

function selectAllAssets() {
    allAssets.forEach(asset => selectedAssets.add(asset.symbol));
    document.querySelectorAll('#assetOptions input').forEach(cb => cb.checked = true);
    updateAssetLabel();
    loadChart();
}

function deselectAllAssets() {
    selectedAssets.clear();
    document.querySelectorAll('#assetOptions input').forEach(cb => cb.checked = false);
    updateAssetLabel();
    loadChart();
}

function selectDefaults() {
    selectedAssets.clear();
    allAssets.forEach(asset => {
        const isDefault = isDefaultAsset(asset.symbol);
        const checkbox = document.getElementById(`asset-${asset.symbol}`);
        if (checkbox) {
            checkbox.checked = isDefault;
        }
        if (isDefault) {
            selectedAssets.add(asset.symbol);
        }
    });
    updateAssetLabel();
    loadChart();
}

function updateAssetLabel() {
    const label = document.getElementById('assetFilterLabel');
    const count = document.getElementById('assetCount');
    const size = selectedAssets.size;
    
    count.textContent = size;
    
    if (size === 0) {
        label.textContent = 'No assets selected';
    } else if (size === allAssets.length) {
        label.textContent = 'All assets';
    } else if (size <= 3) {
        label.textContent = Array.from(selectedAssets).slice(0, 3).join(', ');
    } else {
        label.textContent = Array.from(selectedAssets).slice(0, 2).join(', ') + ` +${size - 2} more`;
    }
}

function getSelectedAssets() {
    return Array.from(selectedAssets);
}

// Dropdown toggle
document.getElementById('assetFilterBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    document.getElementById('assetDropdown').classList.toggle('show');
});

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!document.getElementById('assetFilterContainer').contains(e.target)) {
        document.getElementById('assetDropdown').classList.remove('show');
    }
});

// Store all data globally for table (unfiltered)
let allHistoryData = [];

async function loadChart() {
    const days = document.getElementById('timeRange').value;
    const chartType = 'line';  // Fixed to line chart
    const selected = getSelectedAssets();
    
    // Always fetch all data, filter client-side (API only supports single asset)
    const url = `/api/${chain}/${protocol}/history?days=${days}`;
    
    const response = await fetch(url);
    allHistoryData = await response.json();  // Store unfiltered data
    
    // Filter for chart only
    let chartData = allHistoryData;
    if (selected.length > 0 && selected.length < allAssets.length) {
        chartData = allHistoryData.filter(d => selected.includes(d.symbol));
    } else if (selected.length === 0) {
        // No assets selected - show nothing in chart
        chartData = [];
    }
    
    // Destroy existing chart
    if (chart) {
        chart.destroy();
    }
    
    // Prepare datasets
    const datasets = chartData.map((assetData, idx) => {
        const colors = [
            '#4ade80', '#60a5fa', '#f59e0b', '#ef4444', '#a78bfa',
            '#ec4899', '#14b8a6', '#f97316', '#8b5cf6', '#06b6d4'
        ];
        const color = colors[idx % colors.length];
        
        return {
            label: assetData.symbol,
            data: assetData.data.map(d => ({
                x: new Date(d.timestamp),
                y: d.apr
            })),
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.4,
            fill: false
        };
    });
    
    // Create chart
    const ctx = document.getElementById('aprChart').getContext('2d');
    chart = new Chart(ctx, {
        type: chartType,
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: '#1f201f',
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: days <= 7 ? 'day' : days <= 30 ? 'day' : 'week'
                    },
                    grid: { display: false },
                    ticks: { color: '#4a4a4a' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(31, 32, 31, 0.1)' },
                    ticks: {
                        color: '#4a4a4a',
                        callback: (value) => value + '%'
                    }
                }
            }
        }
    });
    
    // Update current APRs table with ALL data (unfiltered)
    updateCurrentAprs(allHistoryData);
}

function updateCurrentAprs(data) {
    const tbody = document.getElementById('currentAprs');
    tbody.innerHTML = '';
    
    // Sort by APR descending
    const sortedData = data.map(assetData => {
        const latest = assetData.data[assetData.data.length - 1];
        if (!latest) return null;
        
        // Calculate 24h change if we have data from ~24h ago
        let change24h = null;
        if (assetData.data.length > 1) {
            const now = new Date(latest.timestamp);
            const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
            
            // Find closest data point to 24h ago
            let closest = assetData.data[0];
            let minDiff = Math.abs(new Date(closest.timestamp) - oneDayAgo);
            
            for (let point of assetData.data) {
                const diff = Math.abs(new Date(point.timestamp) - oneDayAgo);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = point;
                }
            }
            
            change24h = latest.apr - closest.apr;
        }
        
        return {
            symbol: assetData.symbol,
            apr: latest.apr,
            change24h: change24h,
            timestamp: new Date(latest.timestamp)
        };
    }).filter(x => x !== null);
    
    // Store data globally for sorting
    window.tableData = sortedData;
    
    // Apply initial sort
    applySortToTable();
}

function applySortToTable() {
    const tbody = document.getElementById('currentAprs');
    tbody.innerHTML = '';
    
    // Sort the data based on current column and direction
    let sorted = [...window.tableData];
    
    sorted.sort((a, b) => {
        let aVal, bVal;
        
        switch(currentSortColumn) {
            case 0: // Asset
                aVal = a.symbol;
                bVal = b.symbol;
                const cmp = aVal.localeCompare(bVal);
                return currentSortDirection === 'asc' ? cmp : -cmp;
            
            case 1: // APR
                aVal = a.apr;
                bVal = b.apr;
                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            
            case 2: // 24h Change
                aVal = a.change24h ?? -Infinity;
                bVal = b.change24h ?? -Infinity;
                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            
            default:
                return 0;
        }
    });
    
    // Update column headers with arrows
    for (let i = 0; i < 3; i++) {
        const th = document.getElementById(`th-${i}`);
        if (th) {
            let text = th.textContent.replace(/ [↑↓]/g, '');
            if (i === currentSortColumn) {
                text += currentSortDirection === 'asc' ? ' ↑' : ' ↓';
            }
            th.textContent = text;
        }
    }
    
    // Populate table
    sorted.forEach(item => {
        const row = document.createElement('tr');
        
        // Format 24h change
        let changeHtml = '<span class="text-muted">-</span>';
        if (item.change24h !== null) {
            const changeClass = item.change24h >= 0 ? 'text-success' : 'text-danger';
            const changeSymbol = item.change24h >= 0 ? '+' : '';
            changeHtml = `<span class="${changeClass}">${changeSymbol}${item.change24h.toFixed(2)}%</span>`;
        }
        
        // Format timestamp
        const timeAgo = formatTimeAgo(item.timestamp);
        
        row.innerHTML = `
            <td>
                <img src="${protocolLogo}" alt="${protocol}" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle; border-radius: 4px;">
                <strong>${item.symbol}</strong>
            </td>
            <td><span style="color: #4ade80; font-size: 1.1rem; font-weight: 600;">${item.apr.toFixed(2)}%</span></td>
            <td>${changeHtml}</td>
            <td class="text-secondary">${timeAgo}</td>
        `;
        tbody.appendChild(row);
    });
}

function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
}

function sortTable(columnIndex) {
    // Toggle direction if clicking the same column, otherwise default to desc
    if (currentSortColumn === columnIndex) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = columnIndex;
        currentSortDirection = 'desc';
    }
    
    applySortToTable();
}

// Event listeners
document.getElementById('timeRange').addEventListener('change', loadChart);

// Initial load
loadAssets().then(loadChart);
</script>
{% endblock %}

