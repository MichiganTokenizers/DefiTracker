{% extends "base.html" %}

{% block title %}Cardano Lending - YieldLife{% endblock %}

{% block extra_css %}
<style>
    #aprTable {
        margin-bottom: 0;
        background-color: transparent;
    }
    #aprTable th {
        border-top: none;
        border-bottom: 2px solid rgba(0,0,0,0.2);
        padding: 1rem;
        font-weight: 600;
        color: #1a1a1a;
        cursor: pointer;
        user-select: none;
        background-color: transparent;
    }
    #aprTable th:hover {
        color: #333;
    }
    #aprTable td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        color: #1a1a1a;
        background-color: transparent;
    }
    #aprTable tbody tr:hover {
        background-color: rgba(0,0,0,0.05);
    }
    .table-responsive {
        border-radius: 8px;
    }

    /* Multi-select dropdown styles */
    .multi-select-container {
        position: relative;
    }
    .multi-select-btn {
        width: 100%;
        text-align: left;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.2);
        color: var(--carbon-black);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .multi-select-btn:hover {
        border-color: var(--sea-green);
    }
    .multi-select-btn .count-badge {
        background: var(--accent-primary);
        color: #000;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.2);
        border-radius: 6px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .multi-select-dropdown.show {
        display: block;
    }
    .multi-select-actions {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .multi-select-actions button {
        flex: 1;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.2);
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
    }
    .multi-select-actions button:hover {
        background: var(--sea-green);
        color: #fff;
        border-color: var(--sea-green);
    }
    .multi-select-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.15s;
        color: var(--carbon-black);
    }
    .multi-select-option:hover {
        background: rgba(14, 135, 73, 0.1);
    }
    .multi-select-option input {
        margin-right: 10px;
        accent-color: var(--accent-primary);
    }
    .multi-select-option label {
        cursor: pointer;
        margin: 0;
        flex: 1;
    }

    /* Styled cards - sand dune theme */
    .chart-card-dark,
    .card-styled {
        background: radial-gradient(ellipse 100% 70% at 50% 50%, var(--sand-dune) 45%, transparent 92%) !important;
        border-radius: 12px;
    }
    .card-styled h5 {
        color: #1a1a1a;
    }
    .card-styled .text-muted {
        color: #333 !important;
    }

    /* Title card */
    .title-card {
        text-align: center;
    }
    .title-summary {
        font-size: 0.85rem;
        color: #555;
        line-height: 1.4;
        text-align: left;
    }
    .title-section-label {
        font-size: 1.25rem;
        font-weight: 600;
        color: #0033ad;
    }
    .title-protocols-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .title-protocol-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1a1a1a;
    }
    .title-protocol-logo {
        height: 28px;
        width: auto;
    }
    .future-protocol-indicator {
        background: rgba(0,0,0,0.05);
        border-radius: 8px;
        padding: 8px 16px;
        border: 1px dashed rgba(0,0,0,0.2);
    }
    .future-protocol-plus {
        font-size: 1.5rem;
        color: rgba(0,0,0,0.3);
        font-weight: 300;
    }
    .future-protocol-text {
        font-size: 0.8rem;
        color: rgba(0,0,0,0.4);
    }

    /* Chart filters row */
    .chart-filters-row {
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .chart-filters-row .form-label {
        color: #1a1a1a;
        font-weight: 500;
        font-size: 0.85rem;
    }
    .chart-container {
        position: relative;
    }
    .chart-section-title {
        color: #1a1a1a;
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 0.75rem 0;
        text-align: left;
    }

    /* Connected cards - no gap between chart and table */
    .card-top {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        margin-bottom: 0;
    }
    .card-bottom {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        border-top: 1px solid rgba(0,0,0,0.1);
    }

    /* APY Toggle Button Styles */
    .apr-toggle {
        display: flex;
        gap: 0;
    }
    .apr-toggle .btn-check + .btn {
        border: 1px solid var(--sea-green);
        color: var(--sea-green);
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        background: transparent;
    }
    .apr-toggle .btn-check + .btn:hover {
        background-color: rgba(14, 135, 73, 0.1);
    }
    .apr-toggle .btn-check:checked + .btn {
        background-color: var(--sea-green);
        border-color: var(--sea-green);
        color: white;
    }
    .apr-toggle .btn:first-of-type {
        border-radius: 6px 0 0 6px;
    }
    .apr-toggle .btn:last-of-type {
        border-radius: 0 6px 6px 0;
    }
    .apr-toggle .btn:not(:first-of-type):not(:last-of-type) {
        border-radius: 0;
    }

    /* Chart legend styles */
    .chart-legend-info {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        padding: 0.5rem 0;
        font-size: 0.8rem;
        color: #555;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .legend-line {
        width: 24px;
        height: 3px;
        background: #555;
        border-radius: 2px;
    }
    .legend-line.dashed {
        background: repeating-linear-gradient(
            90deg,
            #555 0px,
            #555 4px,
            transparent 4px,
            transparent 8px
        );
        height: 2px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Save Chart Modal -->
<div class="modal fade" id="saveChartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Chart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="saveChartAlert" class="alert d-none" role="alert"></div>
                <form id="saveChartForm" onsubmit="handleSaveChart(event)">
                    <div class="mb-3">
                        <label for="chartName" class="form-label">Chart Name</label>
                        <input type="text" class="form-control" id="chartName" required maxlength="100"
                               placeholder="e.g., My Lending Watchlist">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Title Cards -->
<div class="row mb-3">
    <!-- Left card: Cardano + Summary -->
    <div class="col-md-6 mb-2 mb-md-0">
        <div class="card p-3 card-styled title-card h-100 d-flex justify-content-center">
            <div class="d-flex align-items-center">
                <img src="/static/cardano-symbol.svg" alt="Cardano" class="cardano-logo me-2" width="32" height="32">
                <span class="title-section-label me-3">Cardano</span>
                <p class="title-summary mb-0">Earn yield by supplying assets or borrow against your collateral on Cardano's leading lending markets.</p>
            </div>
        </div>
    </div>
    <!-- Right card: Protocols -->
    <div class="col-md-6">
        <div class="card p-3 card-styled title-card h-100">
            <div class="d-flex align-items-center justify-content-start">
                <div class="me-4">
                    <span class="text-muted title-protocols-label">Protocols</span>
                    <div class="d-flex align-items-center mt-1">
                        <img src="/static/liqwid-logo.png" alt="Liqwid" class="title-protocol-logo me-2">
                        <span class="title-protocol-name">Liqwid</span>
                    </div>
                </div>
                <div class="future-protocol-indicator d-flex align-items-center">
                    <span class="future-protocol-plus">+</span>
                    <span class="future-protocol-text ms-2">Growth incoming</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main content with side panel -->
<div class="row">
    <!-- Left column: Chart and Table -->
    <div class="col-lg-10">
        <!-- Chart Card with Filters -->
        <div class="card p-4 chart-card-dark card-top">
            <h5 class="chart-section-title">Supply & Borrow Rates</h5>
            <!-- Filters -->
            <div class="chart-filters-row mb-3">
                <div class="row g-2 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label">Time Range</label>
                        <select id="timeRange" class="form-select">
                            <option value="1">Last 1 Day</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Protocol</label>
                        <div class="multi-select-container" id="protocolSelectContainer">
                            <button type="button" class="multi-select-btn" id="protocolSelectBtn">
                                <span id="protocolSelectLabel">Liqwid</span>
                            </button>
                            <div class="multi-select-dropdown" id="protocolDropdown">
                                <div class="multi-select-option">
                                    <input type="checkbox" id="protocol-liqwid" value="liqwid" checked onchange="toggleProtocol('liqwid')">
                                    <label for="protocol-liqwid">Liqwid</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Assets</label>
                        <div class="multi-select-container" id="assetSelectContainer">
                            <button type="button" class="multi-select-btn" id="assetSelectBtn">
                                <span id="assetSelectLabel">Top 3 by TVL</span>
                                <span class="count-badge" id="assetCount" style="display: none;">0</span>
                            </button>
                            <div class="multi-select-dropdown" id="assetDropdown">
                                <div class="multi-select-actions">
                                    <button type="button" onclick="selectTop3()">Top 3</button>
                                    <button type="button" onclick="selectAllAssets()">All</button>
                                    <button type="button" onclick="clearAssets()">Clear</button>
                                </div>
                                <div id="assetOptions">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">APY Measure</label>
                        <div class="apr-toggle" role="group" id="apyToggle">
                            <input type="radio" class="btn-check" name="apyType" id="apy1d" value="1d" checked>
                            <label class="btn" for="apy1d" title="1-day actual APY">1d</label>
                            <input type="radio" class="btn-check" name="apyType" id="apy7d" value="7d">
                            <label class="btn" for="apy7d" title="7-day average APY">7d Avg</label>
                            <input type="radio" class="btn-check" name="apyType" id="apy30d" value="30d">
                            <label class="btn" for="apy30d" title="30-day average APY">30d Avg</label>
                        </div>
                    </div>
                    <div class="col-md-2 ms-auto d-flex align-items-end">
                        <button type="button" class="btn btn-login w-100" id="saveChartBtn" onclick="saveCurrentChart()">
                            Save Chart
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chart Legend Info -->
            <div class="chart-legend-info mb-2">
                <div class="legend-item">
                    <div class="legend-line"></div>
                    <span>Supply APY (solid)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line dashed"></div>
                    <span>Borrow APY (dashed)</span>
                </div>
            </div>

            <!-- Chart Canvas -->
            <div class="chart-container" style="height: 420px;">
                <canvas id="combinedChart"></canvas>
            </div>
        </div>

        <!-- Table Card (no margin between chart and table) -->
        <div class="card p-4 card-styled card-bottom">
            <div class="table-responsive">
                <table class="table table-hover" id="aprTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)" id="th-0">Asset</th>
                            <th onclick="sortTable(1)" id="th-1">Supply APY</th>
                            <th onclick="sortTable(2)" id="th-2">Borrow APY</th>
                            <th onclick="sortTable(3)" id="th-3">Spread</th>
                            <th onclick="sortTable(4)" id="th-4">Utilization</th>
                            <th onclick="sortTable(5)" id="th-5">TVL (₳) ↓</th>
                        </tr>
                    </thead>
                    <tbody id="yieldTable">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Right column: Side Panel (full height) -->
    <div class="col-lg-2">
        <div id="sidePanel" class="card p-3 card-styled" style="position: sticky; top: 1rem;">
            <div id="panelDate" style="font-size: 12px; color: var(--carbon-black); margin-bottom: 12px; text-align: center; font-weight: 500; opacity: 0.7;">Hover over chart</div>
            <div id="panelAssets">
                <!-- Populated by JS on mousemove -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let combinedChart = null;
let allData = [];
let latestData = [];
let currentSortColumn = 5; // TVL column
let currentSortDirection = 'desc';

// Global spread bounds (calculated from last 30 days)
let spreadMin = 0;
let spreadMax = 10;

// Selected filters
let selectedAssets = new Set();
let allAssetsList = [];
let apyMeasure = '1d'; // '1d' for actual, '7d' or '30d' for averages
let movingAverageDays = 1; // Derived from apyMeasure

// Color palette for assets
const assetColors = {
    'ADA': '#0033ad',
    'DJED': '#16a34a',
    'iUSD': '#2563eb',
    'USDA': '#d97706',
    'SHEN': '#dc2626',
    'MIN': '#7c3aed',
    'SNEK': '#db2777',
    'NIGHT': '#0d9488',
    'wanUSDC': '#ea580c',
    'wanDAI': '#6d28d9'
};

// Default colors for assets not in palette
const defaultColors = ['#0891b2', '#65a30d', '#e11d48', '#0f766e', '#9333ea'];
let colorIndex = 0;

function getAssetColor(symbol) {
    if (assetColors[symbol]) return assetColors[symbol];
    const color = defaultColors[colorIndex % defaultColors.length];
    colorIndex++;
    assetColors[symbol] = color;
    return color;
}

// Selected protocols
let selectedProtocols = new Set(['liqwid']);

// Dropdown toggle handlers
document.getElementById('assetSelectBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.querySelectorAll('.multi-select-dropdown').forEach(d => {
        if (d.id !== 'assetDropdown') d.classList.remove('show');
    });
    document.getElementById('assetDropdown').classList.toggle('show');
});

document.getElementById('protocolSelectBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.querySelectorAll('.multi-select-dropdown').forEach(d => {
        if (d.id !== 'protocolDropdown') d.classList.remove('show');
    });
    document.getElementById('protocolDropdown').classList.toggle('show');
});

document.addEventListener('click', (e) => {
    if (!e.target.closest('.multi-select-container')) {
        document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
    }
});

function toggleProtocol(protocol) {
    if (selectedProtocols.has(protocol)) {
        selectedProtocols.delete(protocol);
    } else {
        selectedProtocols.add(protocol);
    }
    updateProtocolLabel();
    applyFilters();
}

function updateProtocolLabel() {
    const label = document.getElementById('protocolSelectLabel');
    if (selectedProtocols.size === 0) {
        label.textContent = 'None selected';
    } else {
        label.textContent = [...selectedProtocols].map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(', ');
    }
}

// APY measure toggle event listeners
document.querySelectorAll('input[name="apyType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        apyMeasure = e.target.value;
        movingAverageDays = apyMeasure === '1d' ? 1 : apyMeasure === '7d' ? 7 : 30;
        // Recalculate global spread bounds for the new setting
        updateGlobalSpreadBounds();
        applyFilters();
    });
});

function updateAssetOptions() {
    const container = document.getElementById('assetOptions');
    container.innerHTML = allAssetsList.map((item, idx) => `
        <div class="multi-select-option">
            <input type="checkbox" id="asset-${item.symbol}" value="${item.symbol}"
                   ${selectedAssets.has(item.symbol) ? 'checked' : ''}
                   onchange="toggleAsset('${item.symbol}')">
            <label for="asset-${item.symbol}">
                <span style="color: ${getAssetColor(item.symbol)};">●</span>
                ${item.symbol}
                <small class="text-muted ms-1">${formatTVL(item.total_supply)}</small>
            </label>
        </div>
    `).join('');

    updateAssetLabel();
}

function formatTVL(value) {
    if (!value) return '';
    // ADA symbol with double crossbar (Unicode combining characters for the look)
    const adaSymbol = '<span style="font-family: sans-serif; font-weight: 700;">₳</span>';
    if (value >= 1e9) return `${adaSymbol}${(value / 1e9).toFixed(1)}B`;
    if (value >= 1e6) return `${adaSymbol}${(value / 1e6).toFixed(1)}M`;
    if (value >= 1e3) return `${adaSymbol}${(value / 1e3).toFixed(1)}K`;
    return `${adaSymbol}${value.toFixed(0)}`;
}

function toggleAsset(symbol) {
    if (selectedAssets.has(symbol)) {
        selectedAssets.delete(symbol);
    } else {
        selectedAssets.add(symbol);
    }
    updateAssetLabel();
    applyFilters();
}

function selectTop3() {
    selectedAssets.clear();
    // Select top 3 by TVL (allAssetsList is already sorted by TVL)
    allAssetsList.slice(0, 3).forEach(item => selectedAssets.add(item.symbol));
    document.querySelectorAll('#assetOptions input').forEach(cb => {
        cb.checked = selectedAssets.has(cb.value);
    });
    updateAssetLabel();
    applyFilters();
}

function selectAllAssets() {
    selectedAssets.clear();
    allAssetsList.forEach(item => selectedAssets.add(item.symbol));
    document.querySelectorAll('#assetOptions input').forEach(cb => cb.checked = true);
    updateAssetLabel();
    applyFilters();
}

function clearAssets() {
    selectedAssets.clear();
    document.querySelectorAll('#assetOptions input').forEach(cb => cb.checked = false);
    updateAssetLabel();
    applyFilters();
}

function updateAssetLabel() {
    const label = document.getElementById('assetSelectLabel');
    const badge = document.getElementById('assetCount');
    const count = selectedAssets.size;

    if (count === 0) {
        label.textContent = 'No assets selected';
        badge.style.display = 'none';
    } else if (count === allAssetsList.length) {
        label.textContent = 'All assets';
        badge.style.display = 'none';
    } else if (count <= 2) {
        label.textContent = [...selectedAssets].join(', ');
        badge.style.display = 'none';
    } else {
        label.textContent = [...selectedAssets].slice(0, 2).join(', ') + ` +${count - 2} more`;
        badge.textContent = count;
        badge.style.display = 'inline';
    }
}

// Calculate moving average for data array
function calculateMovingAverage(dataPoints, window) {
    if (window <= 1) return dataPoints;

    const result = [];
    for (let i = 0; i < dataPoints.length; i++) {
        const start = Math.max(0, i - window + 1);
        const windowData = dataPoints.slice(start, i + 1);

        const supplyAvg = windowData.reduce((sum, d) => sum + (d.supply_apy || 0), 0) / windowData.length;
        const borrowAvg = windowData.reduce((sum, d) => sum + (d.borrow_apy || 0), 0) / windowData.length;
        const spreadAvg = windowData.reduce((sum, d) => sum + (d.spread || 0), 0) / windowData.length;

        result.push({
            ...dataPoints[i],
            supply_apy: supplyAvg,
            borrow_apy: borrowAvg,
            spread: spreadAvg
        });
    }
    return result;
}

// Cache for historical data to avoid redundant API calls
let cachedHistoryData = null;
let cachedHistoryDays = 0;
let isFirstLoad = true;

async function loadData() {
    const days = parseInt(document.getElementById('timeRange').value);

    // Determine how much data to fetch
    // Always fetch at least 30 days so we can filter locally for shorter ranges
    const fetchDays = Math.max(days, 30);

    // Fetch new data if we don't have enough cached
    if (!cachedHistoryData || fetchDays > cachedHistoryDays) {
        const historyResponse = await fetch(`/api/liqwid/lending?days=${fetchDays}`);
        cachedHistoryData = await historyResponse.json();
        cachedHistoryDays = fetchDays;
        console.log(`Fetched ${fetchDays} days of lending data, got ${cachedHistoryData.length} assets`);
    }

    // Filter cached data to the requested time range
    const cutoffMs = Date.now() - (days * 24 * 60 * 60 * 1000);
    allData = cachedHistoryData.map(asset => ({
        symbol: asset.symbol,
        data: asset.data.filter(d => new Date(d.timestamp).getTime() >= cutoffMs)
    }));

    console.log(`Filtered to ${days} days: ${allData.map(a => a.symbol + ':' + a.data.length).join(', ')}`);

    // Load latest data only once (doesn't change with time range)
    if (isFirstLoad) {
        const latestResponse = await fetch('/api/liqwid/lending/latest');
        latestData = await latestResponse.json();

        // Store assets list sorted by TVL (already sorted from API)
        allAssetsList = latestData.map(item => ({
            symbol: item.symbol,
            total_supply: item.total_supply
        }));

        // Default to top 3 by TVL only on first load
        selectedAssets.clear();
        allAssetsList.slice(0, 3).forEach(item => selectedAssets.add(item.symbol));

        isFirstLoad = false;
    }

    // Calculate global spread bounds from ALL assets (not just selected)
    updateGlobalSpreadBounds();

    // Initialize asset options
    updateAssetOptions();

    // Apply filters
    applyFilters();
}

// Calculate spread bounds from ALL assets' smoothed data
function updateGlobalSpreadBounds() {
    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
    const allSmoothedSpreads = [];

    // Calculate smoothed spreads for ALL assets (not just selected)
    allData.forEach(assetData => {
        const smoothedData = calculateMovingAverage(assetData.data, movingAverageDays);
        smoothedData.forEach(d => {
            if (new Date(d.timestamp).getTime() >= thirtyDaysAgo && d.spread !== null) {
                allSmoothedSpreads.push(d.spread);
            }
        });
    });

    if (allSmoothedSpreads.length > 0) {
        spreadMin = Math.min(...allSmoothedSpreads);
        spreadMax = Math.max(...allSmoothedSpreads);
    }
}

function applyFilters() {
    // Filter historical data by selected assets
    const filteredData = allData.filter(d => selectedAssets.has(d.symbol));

    // Filter latest data for table (used for TVL/utilization)
    const filteredLatest = latestData.filter(d => selectedAssets.has(d.symbol));

    updateCharts(filteredData);
    updateTable(filteredData, filteredLatest);
}

function updateCharts(data) {
    const days = parseInt(document.getElementById('timeRange').value);

    // Destroy existing chart
    if (combinedChart) combinedChart.destroy();

    // Build datasets with shaded area between supply and borrow
    const allDatasets = [];

    // Add supply and borrow lines with fill between them
    data.forEach((assetData, assetIndex) => {
        const color = getAssetColor(assetData.symbol);
        const smoothedData = calculateMovingAverage(assetData.data, movingAverageDays);

        // Supply line (solid, circle marker) - will be filled up to borrow line
        allDatasets.push({
            type: 'line',
            label: `${assetData.symbol} Supply`,
            data: smoothedData.map(d => ({
                x: new Date(d.timestamp),
                y: d.supply_apy
            })),
            borderColor: color,
            backgroundColor: color + '66',
            borderWidth: 2.5,
            tension: 0.4,
            fill: {
                target: '+1', // Fill to the next dataset (borrow line)
                above: color + '66', // 40% opacity when supply < borrow (normal)
                below: color + '33'  // Lighter when supply > borrow (rare)
            },
            pointStyle: 'circle',
            pointRadius: 0,
            pointHoverRadius: 5,
            borderDash: [],
            order: 2,
            yAxisID: 'y'
        });

        // Borrow line (dashed, triangle marker)
        allDatasets.push({
            type: 'line',
            label: `${assetData.symbol} Borrow`,
            data: smoothedData.map(d => ({
                x: new Date(d.timestamp),
                y: d.borrow_apy
            })),
            borderColor: color,
            backgroundColor: 'transparent',
            borderWidth: 2.5,
            tension: 0.4,
            fill: false,
            pointStyle: 'triangle',
            pointRadius: 0,
            pointHoverRadius: 5,
            borderDash: [5, 5],
            order: 1,
            yAxisID: 'y'
        });
    });

    // Create combined chart
    const ctx = document.getElementById('combinedChart').getContext('2d');
    combinedChart = new Chart(ctx, {
        type: 'line',
        data: { datasets: allDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#1a1a1a',
                        usePointStyle: true,
                        padding: 15,
                        font: { size: 11 }
                    }
                },
                filler: {
                    propagate: false
                },
                tooltip: {
                    enabled: false
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: days <= 7 ? 'day' : days <= 30 ? 'day' : 'week' },
                    grid: { display: false },
                    ticks: { color: '#1a1a1a' }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.1)' },
                    ticks: {
                        color: '#1a1a1a',
                        stepSize: 1,
                        callback: (value) => value + '%'
                    },
                    title: {
                        display: true,
                        text: 'APY',
                        color: '#1a1a1a'
                    }
                }
            }
        }
    });

    // Update side panel on mousemove
    const canvas = document.getElementById('combinedChart');
    canvas.addEventListener('mousemove', function(e) {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;

        // Get timestamp from X position
        const xScale = combinedChart.scales.x;
        const timestamp = xScale.getValueForPixel(mouseX);

        if (timestamp) {
            updateSidePanel(timestamp, combinedChart.data.datasets);
        }
    });

    // Clear side panel when mouse leaves chart
    canvas.addEventListener('mouseleave', function() {
        document.getElementById('panelDate').textContent = 'Hover over chart';
        document.getElementById('panelAssets').innerHTML = '';
    });
}

function updateSidePanel(timestamp, datasets) {
    const date = new Date(timestamp);
    const panelDate = document.getElementById('panelDate');
    panelDate.textContent = date.toLocaleDateString();
    panelDate.style.opacity = '1';

    // Group datasets by asset
    const assetData = {};
    datasets.forEach(dataset => {
        const label = dataset.label;
        const parts = label.split(' ');
        const type = parts.pop(); // 'Supply' or 'Borrow'
        const asset = parts.join(' ');

        if (!assetData[asset]) {
            assetData[asset] = { color: dataset.borderColor };
        }

        // Find nearest data point to timestamp
        const nearestPoint = dataset.data.reduce((prev, curr) => {
            const prevDiff = Math.abs(prev.x.getTime() - timestamp);
            const currDiff = Math.abs(curr.x.getTime() - timestamp);
            return currDiff < prevDiff ? curr : prev;
        }, dataset.data[0]);

        if (nearestPoint) {
            assetData[asset][type.toLowerCase()] = nearestPoint.y;
        }
    });

    // Build HTML for side panel with YieldLife theme
    let html = '';
    Object.entries(assetData).forEach(([asset, values]) => {
        const spread = (values.borrow || 0) - (values.supply || 0);
        // Use same color scale as table (30-day bounds: green for low spread, red for high)
        const spreadColor = getSpreadColor(spread, spreadMin, spreadMax);

        html += `
            <div style="margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid rgba(31, 32, 31, 0.1);">
                <div style="font-weight: 600; color: ${values.color}; margin-bottom: 8px; font-size: 17px;">${asset}</div>
                <div style="display: flex; justify-content: space-between; color: var(--carbon-black); margin-bottom: 3px;">
                    <span style="opacity: 0.7;">Supply</span>
                    <span style="font-weight: 600;">${values.supply?.toFixed(2) ?? '-'}%</span>
                </div>
                <div style="display: flex; justify-content: space-between; color: var(--carbon-black); margin-bottom: 8px;">
                    <span style="opacity: 0.7;">Borrow</span>
                    <span style="font-weight: 600;">${values.borrow?.toFixed(2) ?? '-'}%</span>
                </div>
                <div style="text-align: center; background: rgba(31, 32, 31, 0.05); border-radius: 6px; padding: 8px;">
                    <span style="font-size: 20px; font-weight: 700; color: ${spreadColor};">
                        ${spread >= 0 ? '+' : ''}${spread.toFixed(2)}%
                    </span>
                    <span style="font-size: 10px; color: var(--carbon-black); opacity: 0.6; display: block; margin-top: 2px;">spread</span>
                </div>
            </div>
        `;
    });

    // Remove last border
    html = html.replace(/border-bottom: 1px solid rgba\(31, 32, 31, 0\.1\);([^<]*<\/div>\s*$)/, '$1');

    document.getElementById('panelAssets').innerHTML = html;
}

function updateTable(historyData, latestDataForTVL) {
    // Calculate table data using the same moving average as the chart
    // historyData is the time-series data, latestDataForTVL provides TVL/utilization
    const tableData = historyData.map(assetData => {
        const smoothedData = calculateMovingAverage(assetData.data, movingAverageDays);
        if (smoothedData.length === 0) return null;

        const latest = smoothedData[smoothedData.length - 1];

        // Get TVL and utilization from latestData (most accurate)
        const latestInfo = latestDataForTVL.find(d => d.symbol === assetData.symbol);

        return {
            symbol: assetData.symbol,
            supply_apy: latest.supply_apy,
            borrow_apy: latest.borrow_apy,
            spread: latest.spread,
            utilization: latestInfo?.utilization ?? latest.utilization,
            total_supply: latestInfo?.total_supply ?? latest.total_supply
        };
    }).filter(x => x !== null);

    window.tableData = tableData;
    applySortToTable();
}

function applySortToTable() {
    const tbody = document.getElementById('yieldTable');
    tbody.innerHTML = '';

    let sorted = [...(window.tableData || [])];

    sorted.sort((a, b) => {
        let aVal, bVal;
        switch(currentSortColumn) {
            case 0: // Asset
                return currentSortDirection === 'asc' ?
                    a.symbol.localeCompare(b.symbol) : b.symbol.localeCompare(a.symbol);
            case 1: // Supply APY
                aVal = a.supply_apy ?? -Infinity;
                bVal = b.supply_apy ?? -Infinity;
                break;
            case 2: // Borrow APY
                aVal = a.borrow_apy ?? -Infinity;
                bVal = b.borrow_apy ?? -Infinity;
                break;
            case 3: // Spread
                aVal = a.spread ?? -Infinity;
                bVal = b.spread ?? -Infinity;
                break;
            case 4: // Utilization
                aVal = a.utilization ?? -Infinity;
                bVal = b.utilization ?? -Infinity;
                break;
            case 5: // TVL
                aVal = a.total_supply ?? -Infinity;
                bVal = b.total_supply ?? -Infinity;
                break;
            default:
                return 0;
        }
        return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
    });

    // Get APY measure label
    const apyLabel = apyMeasure === '1d' ? '1d' : apyMeasure === '7d' ? '7d' : '30d';

    // Update column headers with APY measure
    const baseHeaders = ['Asset', `Supply (${apyLabel})`, `Borrow (${apyLabel})`, `Spread (${apyLabel})`, 'Utilization', 'TVL (₳)'];
    for (let i = 0; i < 6; i++) {
        const th = document.getElementById(`th-${i}`);
        if (th) {
            let text = baseHeaders[i];
            if (i === currentSortColumn) {
                text += currentSortDirection === 'asc' ? ' ↑' : ' ↓';
            }
            th.textContent = text;
        }
    }

    // Use global spread bounds (calculated from last 30 days)
    sorted.forEach(item => {
        const color = getAssetColor(item.symbol);
        const utilPercent = item.utilization ? (item.utilization * 100).toFixed(1) : '-';

        // Scale spread color from green (min) to red (max) using 30-day bounds
        const spreadColor = getSpreadColor(item.spread, spreadMin, spreadMax);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <span style="color: ${color}; font-size: 1.2em;">●</span>
                <strong class="ms-2">${item.symbol}</strong>
            </td>
            <td><span style="color: #1a1a1a; font-weight: 600;">${item.supply_apy?.toFixed(2) ?? '-'}%</span></td>
            <td><span style="color: #1a1a1a; font-weight: 600;">${item.borrow_apy?.toFixed(2) ?? '-'}%</span></td>
            <td><span style="color: ${spreadColor}; font-weight: 600;">${item.spread?.toFixed(2) ?? '-'}%</span></td>
            <td>${utilPercent}%</td>
            <td>${formatTVL(item.total_supply)}</td>
        `;
        tbody.appendChild(row);
    });
}

function getSpreadColor(spread, minSpread, maxSpread) {
    if (spread === null || spread === undefined) return '#666';

    // Normalize spread to 0-1 range (0 = min/green, 1 = max/red)
    const range = maxSpread - minSpread;
    if (range === 0) return '#666';

    const normalized = (spread - minSpread) / range;

    // Interpolate from green (#16a34a) to red (#dc2626)
    const r = Math.round(22 + (220 - 22) * normalized);
    const g = Math.round(163 + (38 - 163) * normalized);
    const b = Math.round(74 + (38 - 74) * normalized);

    return `rgb(${r}, ${g}, ${b})`;
}

function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
}

function sortTable(columnIndex) {
    if (currentSortColumn === columnIndex) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = columnIndex;
        currentSortDirection = 'desc';
    }
    applySortToTable();
}

// Event listeners
document.getElementById('timeRange').addEventListener('change', loadData);

// Check for saved chart_id in URL and load settings
async function loadSavedChartSettings() {
    const urlParams = new URLSearchParams(window.location.search);
    const chartId = urlParams.get('chart_id');

    if (!chartId) return null;

    try {
        const response = await fetch('/api/auth/charts');
        if (!response.ok) return null;

        const charts = await response.json();
        const savedChart = charts.find(c => c.chart_id === parseInt(chartId));

        if (!savedChart || !savedChart.filters) return null;

        return savedChart.filters;
    } catch (e) {
        console.error('Error loading saved chart:', e);
        return null;
    }
}

async function applySavedFilters(filters) {
    // Apply time range
    if (filters.days) {
        document.getElementById('timeRange').value = filters.days;
    }

    // Apply APY measure
    if (filters.apyMeasure) {
        apyMeasure = filters.apyMeasure;
        movingAverageDays = apyMeasure === '1d' ? 1 : apyMeasure === '7d' ? 7 : 30;
        document.querySelectorAll('input[name="apyType"]').forEach(radio => {
            radio.checked = radio.value === apyMeasure;
        });
    } else if (filters.movingAverage) {
        // Legacy support for old saved charts
        movingAverageDays = filters.movingAverage;
        apyMeasure = movingAverageDays === 1 ? '1d' : movingAverageDays === 7 ? '7d' : '30d';
        document.querySelectorAll('input[name="apyType"]').forEach(radio => {
            radio.checked = radio.value === apyMeasure;
        });
    }

    // Apply selected assets (after data is loaded)
    if (filters.assets && filters.assets.length > 0) {
        selectedAssets.clear();
        filters.assets.forEach(symbol => selectedAssets.add(symbol));

        // Update checkboxes
        document.querySelectorAll('#assetOptions input').forEach(cb => {
            cb.checked = filters.assets.includes(cb.value);
        });

        updateAssetLabel();
    }
}

// Initialize
(async function init() {
    const savedFilters = await loadSavedChartSettings();

    // Apply time range before loading data
    if (savedFilters && savedFilters.days) {
        document.getElementById('timeRange').value = savedFilters.days;
    }

    await loadData();

    // Apply asset filters after data is loaded
    if (savedFilters) {
        await applySavedFilters(savedFilters);
        applyFilters();
    }
})();

// Save Chart functionality
function saveCurrentChart() {
    {% if current_user.is_authenticated %}
    document.getElementById('chartName').value = 'Cardano Lending Chart';
    new bootstrap.Modal(document.getElementById('saveChartModal')).show();
    {% else %}
    new bootstrap.Modal(document.getElementById('authModal')).show();
    {% endif %}
}

async function handleSaveChart(event) {
    event.preventDefault();

    const name = document.getElementById('chartName').value;
    const alert = document.getElementById('saveChartAlert');

    const filters = {
        chain: 'cardano',
        protocol: 'liqwid',
        assets: [...selectedAssets],
        days: parseInt(document.getElementById('timeRange').value),
        apyMeasure: apyMeasure,
        chart_type: 'lending'
    };

    try {
        const response = await fetch('/api/auth/charts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, filters })
        });

        const data = await response.json();

        if (response.ok) {
            alert.textContent = 'Chart saved successfully!';
            alert.className = 'alert alert-success';
            alert.classList.remove('d-none');

            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('saveChartModal')).hide();
                alert.classList.add('d-none');
            }, 1500);
        } else {
            alert.textContent = data.error || 'Failed to save chart';
            alert.className = 'alert alert-danger';
            alert.classList.remove('d-none');
        }
    } catch (e) {
        alert.textContent = 'Connection error. Please try again.';
        alert.className = 'alert alert-danger';
        alert.classList.remove('d-none');
    }
}
</script>
{% endblock %}
