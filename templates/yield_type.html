{% extends "base.html" %}

{% block title %}{{ title }} - DeFi APR Tracker{% endblock %}

{% block extra_css %}
<style>
    .yield-type-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .yield-type-icon {
        font-size: 2.5rem;
    }
    .chain-pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .chain-cardano { background: #0033ad; }
    #aprTable th {
        border-top: none;
        border-bottom: 2px solid rgba(255,255,255,0.2);
        padding: 1rem;
        font-weight: 600;
        color: #b0b3c1;
        cursor: pointer;
        user-select: none;
    }
    #aprTable th:hover {
        color: #ffffff;
    }
    #aprTable td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    #aprTable tbody tr:hover {
        background-color: rgba(255,255,255,0.05);
    }
    
    /* Multi-select dropdown styles */
    .multi-select-container {
        position: relative;
    }
    .multi-select-btn {
        width: 100%;
        text-align: left;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.2);
        color: var(--carbon-black);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 38px;
    }
    .multi-select-btn:hover {
        border-color: var(--sea-green);
    }
    .multi-select-btn .count-badge {
        background: var(--sea-green);
        color: #fff;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.2);
        border-radius: 6px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .multi-select-dropdown.show {
        display: block;
    }
    .multi-select-actions {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .multi-select-actions button {
        flex: 1;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.2);
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
    }
    .multi-select-actions button:hover {
        background: var(--sea-green);
        color: #fff;
        border-color: var(--sea-green);
    }
    .multi-select-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.15s;
    }
    .multi-select-option:hover {
        background: rgba(14, 135, 73, 0.1);
    }
    .multi-select-option input {
        margin-right: 10px;
        accent-color: var(--sea-green);
    }
    .multi-select-option label {
        cursor: pointer;
        flex: 1;
        margin: 0;
        color: var(--carbon-black);
    }
    .multi-select-option img {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border-radius: 4px;
    }
    .multi-select-search {
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .multi-select-search input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid rgba(0,0,0,0.15);
        border-radius: 4px;
        font-size: 0.875rem;
    }
    .multi-select-search input:focus {
        outline: none;
        border-color: var(--sea-green);
    }
</style>
{% endblock %}

{% block content %}
<div class="yield-type-header">
    <span class="yield-type-icon">{{ icon }}</span>
    <div>
        <h2 class="display-6 mb-0">{{ title }}</h2>
        <p class="text-secondary mb-0">{{ description }}</p>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4 g-3">
    <div class="col-md-2">
        <label class="form-label">Time Range</label>
        <select id="timeRange" class="form-select">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Protocols</label>
        <div class="multi-select-container" id="protocolSelectContainer">
            <button type="button" class="multi-select-btn" id="protocolSelectBtn">
                <span id="protocolSelectLabel">All Protocols</span>
                <span class="count-badge" id="protocolCount" style="display: none;">0</span>
            </button>
            <div class="multi-select-dropdown" id="protocolDropdown">
                <div class="multi-select-actions">
                    <button type="button" onclick="selectAllProtocols()">Select All</button>
                    <button type="button" onclick="clearProtocols()">Clear</button>
                </div>
                <div id="protocolOptions">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <label class="form-label">Pairs</label>
        <div class="multi-select-container" id="pairSelectContainer">
            <button type="button" class="multi-select-btn" id="pairSelectBtn">
                <span id="pairSelectLabel">All Pairs</span>
                <span class="count-badge" id="pairCount" style="display: none;">0</span>
            </button>
            <div class="multi-select-dropdown" id="pairDropdown">
                <div class="multi-select-search">
                    <input type="text" id="pairSearch" placeholder="Search pairs..." oninput="filterPairOptions()">
                </div>
                <div class="multi-select-actions">
                    <button type="button" onclick="selectAllPairs()">Select All</button>
                    <button type="button" onclick="clearPairs()">Clear</button>
                </div>
                <div id="pairOptions">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button type="button" class="btn btn-outline-primary" id="saveChartBtn" onclick="saveCurrentChart()">
            Save Chart
        </button>
    </div>
</div>

<!-- Save Chart Modal -->
<div class="modal fade" id="saveChartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Chart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="saveChartAlert" class="alert d-none" role="alert"></div>
                <form id="saveChartForm" onsubmit="handleSaveChart(event)">
                    <div class="mb-3">
                        <label for="chartName" class="form-label">Chart Name</label>
                        <input type="text" class="form-control" id="chartName" required maxlength="100" 
                               placeholder="e.g., My {{ title }} Watchlist">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Chart -->
<div class="row">
    <div class="col-12">
        <div class="card p-4" style="height: 700px;">
            <canvas id="aprChart"></canvas>
        </div>
    </div>
</div>

<!-- Full Table -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card p-4">
            <h5 class="mb-3">All {{ title }}</h5>
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="aprTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)" id="th-0">Asset</th>
                            <th onclick="sortTable(1)" id="th-1">Chain</th>
                            <th onclick="sortTable(2)" id="th-2">Protocol</th>
                            <th onclick="sortTable(3)" id="th-3">Current APR ↓</th>
                            <th onclick="sortTable(4)" id="th-4">24h Change</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="yieldTable">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const yieldType = "{{ yield_type }}";
let chart = null;
let allData = [];
let latestData = [];
let currentSortColumn = 3;
let currentSortDirection = 'desc';

// Protocol definitions
const availableProtocols = [
    { id: 'minswap', name: 'Minswap', logo: '/static/minswap-logo.png' },
    { id: 'sundaeswap', name: 'SundaeSwap', logo: '/static/sundaeswap-logo.ico' },
    { id: 'wingriders', name: 'WingRiders', logo: '/static/wingriders-logo.svg' },
    { id: 'muesliswap', name: 'MuesliSwap', logo: '/static/muesliswap-logo.png' },
    { id: 'liqwid', name: 'Liqwid', logo: '/static/liqwid-logo.png' },
    { id: 'kinetic', name: 'Kinetic', logo: '/static/kinetic-logo.png' },
    { id: 'blazeswap', name: 'BlazeSwap', logo: '/static/blazeswap-logo.svg' }
];

// Protocol logo mapping
const protocolLogos = {};
availableProtocols.forEach(p => protocolLogos[p.id] = p.logo);

// Selected filters
let selectedProtocols = new Set(availableProtocols.map(p => p.id)); // All selected by default
let selectedPairs = new Set(); // Empty = all pairs
let allPairs = []; // Will be populated from data

// Chain colors
const chainColors = {
    'cardano': '#0033ad'
};

// ==========================================
// Multi-select dropdown functionality
// ==========================================

function initializeProtocolDropdown() {
    const container = document.getElementById('protocolOptions');
    container.innerHTML = availableProtocols.map(p => `
        <div class="multi-select-option">
            <input type="checkbox" id="proto-${p.id}" value="${p.id}" 
                   ${selectedProtocols.has(p.id) ? 'checked' : ''} 
                   onchange="toggleProtocol('${p.id}')">
            <img src="${p.logo}" onerror="this.style.display='none'">
            <label for="proto-${p.id}">${p.name}</label>
        </div>
    `).join('');
    updateProtocolLabel();
}

function toggleProtocol(protocolId) {
    if (selectedProtocols.has(protocolId)) {
        selectedProtocols.delete(protocolId);
    } else {
        selectedProtocols.add(protocolId);
    }
    updateProtocolLabel();
    updatePairOptions();
    applyFilters();
}

function selectAllProtocols() {
    availableProtocols.forEach(p => selectedProtocols.add(p.id));
    document.querySelectorAll('#protocolOptions input').forEach(cb => cb.checked = true);
    updateProtocolLabel();
    updatePairOptions();
    applyFilters();
}

function clearProtocols() {
    selectedProtocols.clear();
    document.querySelectorAll('#protocolOptions input').forEach(cb => cb.checked = false);
    updateProtocolLabel();
    updatePairOptions();
    applyFilters();
}

function updateProtocolLabel() {
    const label = document.getElementById('protocolSelectLabel');
    const badge = document.getElementById('protocolCount');
    
    if (selectedProtocols.size === 0) {
        label.textContent = 'No protocols';
        badge.style.display = 'none';
    } else if (selectedProtocols.size === availableProtocols.length) {
        label.textContent = 'All Protocols';
        badge.style.display = 'none';
    } else if (selectedProtocols.size === 1) {
        const proto = availableProtocols.find(p => selectedProtocols.has(p.id));
        label.textContent = proto ? proto.name : 'Selected';
        badge.style.display = 'none';
    } else {
        label.textContent = 'Protocols';
        badge.textContent = selectedProtocols.size;
        badge.style.display = 'inline';
    }
}

function updatePairOptions() {
    // Get pairs only from selected protocols
    const filteredPairs = allPairs.filter(p => selectedProtocols.has(p.protocol));
    
    // Get unique pair symbols
    const uniquePairs = [...new Set(filteredPairs.map(p => p.symbol))].sort();
    
    const container = document.getElementById('pairOptions');
    container.innerHTML = uniquePairs.map(symbol => {
        // Find which protocols have this pair
        const protocols = [...new Set(filteredPairs.filter(p => p.symbol === symbol).map(p => p.protocol))];
        const protocolNames = protocols.map(pid => {
            const proto = availableProtocols.find(p => p.id === pid);
            return proto ? proto.name : pid;
        }).join(', ');
        
        return `
            <div class="multi-select-option pair-option" data-symbol="${symbol.toLowerCase()}">
                <input type="checkbox" id="pair-${symbol}" value="${symbol}" 
                       ${selectedPairs.size === 0 || selectedPairs.has(symbol) ? 'checked' : ''} 
                       onchange="togglePair('${symbol}')">
                <label for="pair-${symbol}">
                    <strong>${symbol}</strong>
                    <small class="text-muted d-block">${protocolNames}</small>
                </label>
            </div>
        `;
    }).join('');
    
    // Remove any selected pairs that are no longer available
    selectedPairs.forEach(pair => {
        if (!uniquePairs.includes(pair)) {
            selectedPairs.delete(pair);
        }
    });
    
    updatePairLabel();
}

function filterPairOptions() {
    const search = document.getElementById('pairSearch').value.toLowerCase();
    document.querySelectorAll('.pair-option').forEach(opt => {
        const symbol = opt.dataset.symbol;
        opt.style.display = symbol.includes(search) ? '' : 'none';
    });
}

function togglePair(symbol) {
    // If all pairs were selected (selectedPairs is empty), switching to explicit selection
    if (selectedPairs.size === 0) {
        // Select all pairs except this one
        const allSymbols = [...document.querySelectorAll('#pairOptions input')].map(cb => cb.value);
        allSymbols.forEach(s => {
            if (s !== symbol) selectedPairs.add(s);
        });
    } else if (selectedPairs.has(symbol)) {
        selectedPairs.delete(symbol);
    } else {
        selectedPairs.add(symbol);
    }
    
    // If all pairs are now selected, clear the set (means "all")
    const allSymbols = [...document.querySelectorAll('#pairOptions input')].map(cb => cb.value);
    if (selectedPairs.size === allSymbols.length) {
        selectedPairs.clear();
        document.querySelectorAll('#pairOptions input').forEach(cb => cb.checked = true);
    }
    
    updatePairLabel();
    applyFilters();
}

function selectAllPairs() {
    selectedPairs.clear(); // Empty means all
    document.querySelectorAll('#pairOptions input').forEach(cb => cb.checked = true);
    updatePairLabel();
    applyFilters();
}

function clearPairs() {
    const allSymbols = [...document.querySelectorAll('#pairOptions input')].map(cb => cb.value);
    selectedPairs = new Set(); // Start fresh
    document.querySelectorAll('#pairOptions input').forEach(cb => cb.checked = false);
    updatePairLabel();
    applyFilters();
}

function updatePairLabel() {
    const label = document.getElementById('pairSelectLabel');
    const badge = document.getElementById('pairCount');
    const allSymbols = [...document.querySelectorAll('#pairOptions input')].map(cb => cb.value);
    const checkedCount = document.querySelectorAll('#pairOptions input:checked').length;
    
    if (selectedPairs.size === 0 && checkedCount === allSymbols.length) {
        label.textContent = 'All Pairs';
        badge.style.display = 'none';
    } else if (checkedCount === 0) {
        label.textContent = 'No pairs';
        badge.style.display = 'none';
    } else if (checkedCount === 1) {
        const checked = document.querySelector('#pairOptions input:checked');
        label.textContent = checked ? checked.value : 'Selected';
        badge.style.display = 'none';
    } else {
        label.textContent = 'Pairs';
        badge.textContent = checkedCount;
        badge.style.display = 'inline';
    }
}

// Dropdown toggle handlers
document.getElementById('protocolSelectBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('protocolDropdown').classList.toggle('show');
    document.getElementById('pairDropdown').classList.remove('show');
});

document.getElementById('pairSelectBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('pairDropdown').classList.toggle('show');
    document.getElementById('protocolDropdown').classList.remove('show');
});

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.multi-select-container')) {
        document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
    }
});

// ==========================================
// Data loading and filtering
// ==========================================

async function loadData() {
    const days = document.getElementById('timeRange').value;
    
    // Load historical data
    const historyResponse = await fetch(`/api/yields/${yieldType}?days=${days}`);
    allData = await historyResponse.json();
    
    // Load latest for table
    const latestResponse = await fetch(`/api/yields/${yieldType}/latest`);
    latestData = await latestResponse.json();
    
    // Extract all pairs with their protocols
    allPairs = latestData.map(item => ({
        symbol: item.symbol,
        protocol: item.protocol
    }));
    
    // Initialize pair options now that we have data
    updatePairOptions();
    
    // Apply filters
    applyFilters();
}

function applyFilters() {
    // Get checked pairs from the UI
    const checkedPairs = new Set(
        [...document.querySelectorAll('#pairOptions input:checked')].map(cb => cb.value)
    );
    
    // Filter historical data
    let filteredData = allData.filter(d => {
        // Protocol filter
        if (!selectedProtocols.has(d.protocol)) return false;
        // Pair filter (if any pairs are checked)
        if (checkedPairs.size > 0 && !checkedPairs.has(d.symbol)) return false;
        return true;
    });
    
    // Filter latest data for table
    let filteredLatest = latestData.filter(d => {
        if (!selectedProtocols.has(d.protocol)) return false;
        if (checkedPairs.size > 0 && !checkedPairs.has(d.symbol)) return false;
        return true;
    });
    
    updateChart(filteredData);
    updateTable(filteredLatest);
}

function updateChart(data) {
    if (chart) {
        chart.destroy();
    }
    
    const days = document.getElementById('timeRange').value;
    
    // Take top 8 by latest APR for chart
    const sortedData = [...data].sort((a, b) => {
        const aLatest = a.data[a.data.length - 1]?.apr || 0;
        const bLatest = b.data[b.data.length - 1]?.apr || 0;
        return bLatest - aLatest;
    }).slice(0, 8);
    
    const datasets = sortedData.map((item, idx) => {
        const colors = [
            '#4ade80', '#60a5fa', '#f59e0b', '#ef4444', '#a78bfa',
            '#ec4899', '#14b8a6', '#f97316'
        ];
        const color = colors[idx % colors.length];
        
        return {
            label: `${item.symbol} (${item.protocol})`,
            data: item.data.map(d => ({
                x: new Date(d.timestamp),
                y: d.apr
            })),
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.4,
            fill: false
        };
    });
    
    const ctx = document.getElementById('aprChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: '#1f201f',
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: days <= 7 ? 'day' : days <= 30 ? 'day' : 'week' },
                    grid: { display: false },
                    ticks: { color: '#4a4a4a' }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(31, 32, 31, 0.1)' },
                    ticks: {
                        color: '#4a4a4a',
                        callback: (value) => value + '%'
                    }
                }
            }
        }
    });
}

function updateTable(data) {
    window.tableData = data.map(item => ({
        symbol: item.symbol,
        chain: item.chain,
        protocol: item.protocol,
        apr: item.apr,
        market_type: item.market_type,
        timestamp: new Date(item.timestamp),
        change24h: null // Would need historical data to calculate
    }));
    
    applySortToTable();
}

function applySortToTable() {
    const tbody = document.getElementById('yieldTable');
    tbody.innerHTML = '';
    
    let sorted = [...(window.tableData || [])];
    
    sorted.sort((a, b) => {
        let aVal, bVal;
        
        switch(currentSortColumn) {
            case 0: // Asset
                return currentSortDirection === 'asc' ? 
                    a.symbol.localeCompare(b.symbol) : b.symbol.localeCompare(a.symbol);
            case 1: // Chain
                return currentSortDirection === 'asc' ? 
                    a.chain.localeCompare(b.chain) : b.chain.localeCompare(a.chain);
            case 2: // Protocol
                return currentSortDirection === 'asc' ? 
                    a.protocol.localeCompare(b.protocol) : b.protocol.localeCompare(a.protocol);
            case 3: // APR
                return currentSortDirection === 'asc' ? a.apr - b.apr : b.apr - a.apr;
            case 4: // 24h Change
                aVal = a.change24h ?? -Infinity;
                bVal = b.change24h ?? -Infinity;
                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            default:
                return 0;
        }
    });
    
    // Update column headers
    for (let i = 0; i < 5; i++) {
        const th = document.getElementById(`th-${i}`);
        if (th) {
            let text = th.textContent.replace(/ [↑↓]/g, '');
            if (i === currentSortColumn) {
                text += currentSortDirection === 'asc' ? ' ↑' : ' ↓';
            }
            th.textContent = text;
        }
    }
    
    sorted.forEach(item => {
        const logo = protocolLogos[item.protocol] || '';
        const chainClass = `chain-${item.chain}`;
        const timeAgo = formatTimeAgo(item.timestamp);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                ${logo ? `<img src="${logo}" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle; border-radius: 4px;">` : ''}
                <strong>${item.symbol}</strong>
                ${item.market_type ? `<br><small class="text-muted">${item.market_type}</small>` : ''}
            </td>
            <td><span class="chain-pill ${chainClass}">${item.chain}</span></td>
            <td>${item.protocol}</td>
            <td><span style="color: #4ade80; font-size: 1.1rem; font-weight: 600;">${item.apr.toFixed(2)}%</span></td>
            <td><span class="text-muted">-</span></td>
            <td class="text-secondary">${timeAgo}</td>
        `;
        tbody.appendChild(row);
    });
}

function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
}

function sortTable(columnIndex) {
    if (currentSortColumn === columnIndex) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = columnIndex;
        currentSortDirection = 'desc';
    }
    applySortToTable();
}

// Event listeners
document.getElementById('timeRange').addEventListener('change', loadData);

// Initialize
initializeProtocolDropdown();
loadData();

// ==========================================
// Save Chart functionality
// ==========================================

function saveCurrentChart() {
    {% if current_user.is_authenticated %}
    // User is logged in, show save modal
    const protocolNames = [...selectedProtocols].join(', ');
    const protocolText = selectedProtocols.size === availableProtocols.length ? '' : ` (${protocolNames})`;
    document.getElementById('chartName').value = `{{ title }}${protocolText}`;
    new bootstrap.Modal(document.getElementById('saveChartModal')).show();
    {% else %}
    // User not logged in, show auth modal
    new bootstrap.Modal(document.getElementById('authModal')).show();
    {% endif %}
}

async function handleSaveChart(event) {
    event.preventDefault();
    
    const name = document.getElementById('chartName').value;
    const alert = document.getElementById('saveChartAlert');
    
    // Build filters object
    const filters = {
        protocols: selectedProtocols.size === availableProtocols.length ? null : [...selectedProtocols],
        pairs: selectedPairs.size === 0 ? null : [...selectedPairs],
        days: parseInt(document.getElementById('timeRange').value),
        yield_type: yieldType
    };
    
    try {
        const response = await fetch('/api/auth/charts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, filters })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert.textContent = 'Chart saved successfully!';
            alert.className = 'alert alert-success';
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('saveChartModal')).hide();
                alert.classList.add('d-none');
            }, 1500);
        } else {
            alert.textContent = data.error || 'Failed to save chart';
            alert.className = 'alert alert-danger';
            alert.classList.remove('d-none');
        }
    } catch (e) {
        alert.textContent = 'Connection error. Please try again.';
        alert.className = 'alert alert-danger';
        alert.classList.remove('d-none');
    }
}
</script>
{% endblock %}

