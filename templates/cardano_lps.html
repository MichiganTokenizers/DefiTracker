{% extends "base.html" %}

{% block title %}Cardano Liquidity Pools - YieldLife{% endblock %}

{% block extra_css %}
<style>
    #aprTable {
        margin-bottom: 0;
    }
    #aprTable th {
        border-top: none;
        border-bottom: 2px solid rgba(255,255,255,0.2);
        padding: 1rem;
        font-weight: 600;
        color: #b0b3c1;
        user-select: none;
    }
    #aprTable th:hover {
        color: #ffffff;
    }
    #aprTable td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    #aprTable tbody tr:hover {
        background-color: rgba(255,255,255,0.05);
    }
    .table-responsive {
        border-radius: 8px;
    }
    
    /* Multi-select dropdown styles */
    .multi-select-container {
        position: relative;
    }
    .multi-select-btn {
        width: 100%;
        text-align: left;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.2);
        color: var(--carbon-black);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .multi-select-btn:hover {
        border-color: var(--sea-green);
    }
    .multi-select-btn .count-badge {
        background: var(--accent-primary);
        color: #000;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.2);
        border-radius: 6px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .multi-select-dropdown.show {
        display: block;
    }
    .multi-select-actions {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .multi-select-actions button {
        flex: 1;
        padding: 4px 8px;
        font-size: 0.75rem;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.2);
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
    }
    .multi-select-actions button:hover {
        background: var(--sea-green);
        color: #fff;
        border-color: var(--sea-green);
    }
    .multi-select-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.15s;
        color: var(--carbon-black);
    }
    .multi-select-option:hover {
        background: rgba(14, 135, 73, 0.1);
    }
    .multi-select-option input {
        margin-right: 10px;
        accent-color: var(--accent-primary);
    }
    .multi-select-option label {
        cursor: pointer;
        margin: 0;
        flex: 1;
    }
    
    /* Dark chart card */
    .chart-card-dark {
        background: var(--carbon-black) !important;
        border: none;
    }
    
    /* APR Toggle Button Styles */
    .apr-toggle {
        display: flex;
        gap: 0;
    }
    .apr-toggle .btn-check + .btn {
        border: 1px solid var(--sea-green);
        color: var(--sea-green);
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        background: transparent;
    }
    .apr-toggle .btn-check + .btn:hover {
        background-color: rgba(14, 135, 73, 0.1);
    }
    .apr-toggle .btn-check:checked + .btn {
        background-color: var(--sea-green);
        border-color: var(--sea-green);
        color: white;
    }
    .apr-toggle .btn:first-of-type {
        border-radius: 6px 0 0 6px;
    }
    .apr-toggle .btn:last-of-type {
        border-radius: 0 6px 6px 0;
    }
    
    /* Back link */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
    .back-link:hover {
        color: var(--sea-green);
    }
    
    /* Page header */
    .page-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .page-header-icon {
        font-size: 2rem;
    }
    .page-header h2 {
        margin: 0;
        font-size: 1.75rem;
        color: var(--sand-dune);
    }
    .page-header-subtitle {
        color: var(--sand-dune);
        font-size: 0.95rem;
        margin: 0;
    }
    
    /* Filter row */
    .filter-row {
        background-color: var(--sand-dune);
        border-radius: 12px;
        padding: 1.25rem;
        margin-left: 0;
        margin-right: 0;
    }
    .filter-row .form-label {
        color: var(--carbon-black);
        font-weight: 500;
    }
    
    /* Reward Breakdown Pie Charts */
    .breakdown-section {
        margin-top: 2rem;
    }
    .breakdown-section h4 {
        color: var(--sand-dune);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .breakdown-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 1.5rem;
        height: 100%;
        box-shadow: 0 4px 20px rgba(31, 32, 31, 0.1);
    }
    .breakdown-card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .breakdown-card-header img {
        width: 32px;
        height: 32px;
        border-radius: 6px;
    }
    .breakdown-card-header h5 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--carbon-black);
        text-transform: capitalize;
    }
    .breakdown-card-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-left: auto;
    }
    .breakdown-chart-container {
        position: relative;
        height: 180px;
        margin-bottom: 1rem;
    }
    .breakdown-chart-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        pointer-events: none;
    }
    .breakdown-chart-center .swap-fee-label {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .breakdown-chart-center .swap-fee-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
    }
    .breakdown-legend {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .breakdown-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
    }
    .breakdown-legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        flex-shrink: 0;
    }
    .breakdown-legend-label {
        color: var(--text-secondary);
        flex: 1;
    }
    .breakdown-legend-value {
        font-weight: 600;
        color: var(--carbon-black);
    }
    .breakdown-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-secondary);
    }
    .breakdown-filter {
        margin-bottom: 1rem;
    }
    .breakdown-filter select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        border: 1px solid rgba(0,0,0,0.15);
        border-radius: 8px;
        background: #fff;
        color: var(--carbon-black);
        cursor: pointer;
    }
    .breakdown-filter select:focus {
        outline: none;
        border-color: var(--sea-green);
        box-shadow: 0 0 0 2px rgba(14, 135, 73, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<!-- Back Link -->
<a href="/cardano" class="back-link">‚Üê Back to Cardano</a>

<div class="page-header">
    <span class="page-header-icon">üåä</span>
    <div>
        <h2>Cardano Liquidity Pools</h2>
        <p class="page-header-subtitle">Compare LP yields across Minswap, SundaeSwap, and WingRiders</p>
    </div>
</div>

<div class="row mb-4 g-3 filter-row">
    <div class="col-md-2">
        <label class="form-label">Time Range</label>
        <select id="timeRange" class="form-select">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last Year</option>
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">APR Type</label>
        <div class="apr-toggle" role="group" id="aprToggle">
            <input type="radio" class="btn-check" name="aprType" id="apr1d" value="1d">
            <label class="btn" for="apr1d" title="1-day APR snapshot">1d APR</label>
            <input type="radio" class="btn-check" name="aprType" id="apr30d" value="30d" checked>
            <label class="btn" for="apr30d" title="30-day extrapolated APR">30d APR</label>
        </div>
    </div>
    <div class="col-md-4">
        <label class="form-label">Asset Filter</label>
        <div class="multi-select-container" id="assetFilterContainer">
            <button type="button" class="multi-select-btn" id="assetFilterBtn">
                <span id="assetFilterLabel">Loading...</span>
                <span class="count-badge" id="assetCount">0</span>
            </button>
            <div class="multi-select-dropdown" id="assetDropdown">
                <div class="multi-select-actions">
                    <button type="button" onclick="selectAllAssets()">Select All</button>
                    <button type="button" onclick="deselectAllAssets()">Clear</button>
                    <button type="button" onclick="selectDefaults()">Defaults</button>
                </div>
                <div id="assetOptions">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-outline-primary" id="saveChartBtn" onclick="saveCurrentChart()">
            Save Chart
        </button>
    </div>
</div>

<!-- Save Chart Modal -->
<div class="modal fade" id="saveChartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Chart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="saveChartAlert" class="alert d-none" role="alert"></div>
                <form id="saveChartForm" onsubmit="handleSaveChart(event)">
                    <div class="mb-3">
                        <label for="chartName" class="form-label">Chart Name</label>
                        <input type="text" class="form-control" id="chartName" required maxlength="100" 
                               placeholder="e.g., My Cardano LP Watchlist">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card p-4 chart-card-dark" style="height: 700px;">
            <canvas id="aprChart"></canvas>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card p-4">
            <h5 class="mb-3">Current APRs <small class="text-muted" id="aprTypeLabel">(30-day)</small></h5>
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="aprTable">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable(0)" id="th-0">Asset</th>
                            <th style="cursor: pointer;" onclick="sortTable(1)" id="th-1"><span id="aprColumnLabel">APR (30d)</span> ‚Üì</th>
                            <th style="cursor: pointer;" onclick="sortTable(2)" id="th-2">24h Change</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="currentAprs">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Reward Breakdown Pie Charts -->
<div class="breakdown-section">
    <h4>ü•ß Reward Source Breakdown <small class="text-muted" style="font-size: 0.75rem; font-weight: normal;">(1-day APR, TVL-weighted averages)</small></h4>
    <div class="row g-4" id="breakdownCharts">
        <div class="col-12">
            <div class="breakdown-loading">
                <span>Loading reward breakdown...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chain = "{{ chain }}";
const yieldType = "{{ yield_type }}";
let chart = null;
let currentSortColumn = 1;
let currentSortDirection = 'desc';
let allAssets = [];
let selectedAssets = new Set();
let selectedAprType = '30d'; // '1d' or '30d'

// Protocol logo mapping
const protocolLogos = {
    'minswap': '/static/minswap-logo.png',
    'sundaeswap': '/static/sundaeswap-logo.ico',
    'wingriders': '/static/wingriders-logo.svg',
    'liqwid': '/static/liqwid-logo.png'
};

// Line styles per DEX
const protocolLineStyles = {
    'minswap': { borderDash: [], pointStyle: 'circle' },
    'sundaeswap': { borderDash: [5, 5], pointStyle: 'rect' },
    'wingriders': { borderDash: [2, 2], pointStyle: 'triangle' },
    'liqwid': { borderDash: [10, 5], pointStyle: 'star' }
};

// Color palette
const pairColors = [
    '#4ade80', '#60a5fa', '#f59e0b', '#ef4444', '#a78bfa',
    '#ec4899', '#14b8a6', '#f97316', '#8b5cf6', '#06b6d4',
    '#84cc16', '#f43f5e', '#22d3d8', '#fb923c', '#c084fc'
];
const pairColorMap = {};

// Default assets
const defaultAssets = [
    'NIGHT-ADA', 'NIGHT-USDM', 'NIGHT-USDA', 'ADA-NIGHT',
    'ADA-USDM', 'ADA-USDA', 'ADA-DJED', 'ADA-iUSD', 'USDM-ADA', 'USDA-ADA',
    'ADA-SNEK', 'ADA-IAG', 'ADA-WMTX'
];

function isDefaultAsset(symbol) {
    return defaultAssets.some(d => 
        symbol === d || 
        symbol.toUpperCase() === d.toUpperCase() ||
        symbol.includes(d) || 
        d.includes(symbol)
    );
}

async function loadAssets() {
    const response = await fetch(`/api/${chain}/all/assets?yield_type=${yieldType}`);
    const rawAssets = await response.json();
    
    const symbolSet = new Set();
    rawAssets.forEach(a => symbolSet.add(a.symbol));
    allAssets = Array.from(symbolSet).map(s => ({ symbol: s }));
    
    const optionsContainer = document.getElementById('assetOptions');
    optionsContainer.innerHTML = '';
    
    allAssets.forEach(asset => {
        const isDefault = isDefaultAsset(asset.symbol);
        if (isDefault) {
            selectedAssets.add(asset.symbol);
        }
        
        const div = document.createElement('div');
        div.className = 'multi-select-option';
        div.innerHTML = `
            <input type="checkbox" id="asset-${asset.symbol}" value="${asset.symbol}" 
                   ${isDefault ? 'checked' : ''} onchange="toggleAsset('${asset.symbol}')">
            <label for="asset-${asset.symbol}">${asset.symbol}</label>
        `;
        optionsContainer.appendChild(div);
    });
    
    updateAssetLabel();
}

function toggleAsset(symbol) {
    if (selectedAssets.has(symbol)) {
        selectedAssets.delete(symbol);
    } else {
        selectedAssets.add(symbol);
    }
    updateAssetLabel();
    loadChart();
}

function selectAllAssets() {
    allAssets.forEach(asset => selectedAssets.add(asset.symbol));
    document.querySelectorAll('#assetOptions input').forEach(cb => cb.checked = true);
    updateAssetLabel();
    loadChart();
}

function deselectAllAssets() {
    selectedAssets.clear();
    document.querySelectorAll('#assetOptions input').forEach(cb => cb.checked = false);
    updateAssetLabel();
    loadChart();
}

function selectDefaults() {
    selectedAssets.clear();
    allAssets.forEach(asset => {
        const isDefault = isDefaultAsset(asset.symbol);
        const checkbox = document.getElementById(`asset-${asset.symbol}`);
        if (checkbox) checkbox.checked = isDefault;
        if (isDefault) selectedAssets.add(asset.symbol);
    });
    updateAssetLabel();
    loadChart();
}

function updateAssetLabel() {
    const label = document.getElementById('assetFilterLabel');
    const count = document.getElementById('assetCount');
    const size = selectedAssets.size;
    
    count.textContent = size;
    
    if (size === 0) {
        label.textContent = 'No assets selected';
    } else if (size === allAssets.length) {
        label.textContent = 'All assets';
    } else if (size <= 3) {
        label.textContent = Array.from(selectedAssets).slice(0, 3).join(', ');
    } else {
        label.textContent = Array.from(selectedAssets).slice(0, 2).join(', ') + ` +${size - 2} more`;
    }
}

function getSelectedAssets() {
    return Array.from(selectedAssets);
}

// Dropdown toggle
document.getElementById('assetFilterBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    document.getElementById('assetDropdown').classList.toggle('show');
});

document.addEventListener('click', function(e) {
    if (!document.getElementById('assetFilterContainer').contains(e.target)) {
        document.getElementById('assetDropdown').classList.remove('show');
    }
});

let allHistoryData = [];

function getPairColor(symbol) {
    if (!pairColorMap[symbol]) {
        const colorIndex = Object.keys(pairColorMap).length % pairColors.length;
        pairColorMap[symbol] = pairColors[colorIndex];
    }
    return pairColorMap[symbol];
}

function updateAprLabels() {
    const is1d = selectedAprType === '1d';
    const typeLabel = document.getElementById('aprTypeLabel');
    const columnLabel = document.getElementById('aprColumnLabel');
    if (typeLabel) typeLabel.textContent = is1d ? '(1-day)' : '(30-day)';
    if (columnLabel) columnLabel.textContent = is1d ? 'APR (1d)' : 'APR (30d)';
}

async function loadChart() {
    const days = document.getElementById('timeRange').value;
    const selected = getSelectedAssets();
    
    const url = `/api/${chain}/all/history?days=${days}&yield_type=${yieldType}`;
    
    const response = await fetch(url);
    allHistoryData = await response.json();
    
    let chartData = allHistoryData;
    if (selected.length > 0 && selected.length < allAssets.length) {
        chartData = allHistoryData.filter(d => selected.includes(d.symbol));
    } else if (selected.length === 0) {
        chartData = [];
    }
    
    if (chart) {
        chart.destroy();
        chart = null;
    }
    
    // Update labels
    updateAprLabels();
    
    const is1d = selectedAprType === '1d';
    
    const datasets = chartData.map((assetData) => {
        const protocol = assetData.protocol;
        const symbol = assetData.symbol;
        const version = assetData.version;
        const color = getPairColor(symbol);
        const lineStyle = protocolLineStyles[protocol] || { borderDash: [], pointStyle: 'circle' };
        
        const versionSuffix = version ? ` ${version}` : '';
        const label = `${symbol} (${protocol}${versionSuffix})`;
        
        // Select which APR field to use - no fallback
        let processedData;
        if (is1d) {
            // Use apr_1d only - no fallback to 30d
            processedData = assetData.data
                .filter(d => d.apr_1d != null)
                .map(d => ({
                    x: new Date(d.timestamp),
                    y: d.apr_1d
                }));
        } else {
            // Use stored apr value (30-day)
            processedData = assetData.data
                .filter(d => d.apr != null)
                .map(d => ({
                    x: new Date(d.timestamp),
                    y: d.apr
                }));
        }
        
        return {
            label: label,
            data: processedData,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            borderDash: lineStyle.borderDash,
            pointStyle: lineStyle.pointStyle,
            tension: 0.4,
            fill: false
        };
    }).filter(ds => ds.data.length > 0);
    
    const aprTypeLabel = is1d ? '1-Day APR' : '30-Day APR';
    
    // Handle empty datasets gracefully
    const noDataMessage = datasets.length === 0 
        ? (is1d ? 'No 1-day APR data available for selected assets' : 'No data available for selected assets')
        : null;
    
    const ctx = document.getElementById('aprChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: noDataMessage || aprTypeLabel,
                    color: noDataMessage ? '#888' : '#ddd6b9',
                    font: { size: 14, weight: 'normal' },
                    padding: { bottom: 10 }
                },
                legend: {
                    display: datasets.length > 0,
                    labels: { 
                        color: '#ddd6b9',
                        usePointStyle: true,
                        padding: 15,
                        font: { size: 11 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: days <= 7 ? 'day' : days <= 30 ? 'day' : 'week' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#b0b3c1' },
                    display: datasets.length > 0
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: {
                        color: '#b0b3c1',
                        callback: (value) => value + '%'
                    },
                    display: datasets.length > 0
                }
            }
        }
    });
    
    updateCurrentAprs(chartData);
}

function updateCurrentAprs(data) {
    const tbody = document.getElementById('currentAprs');
    tbody.innerHTML = '';
    
    const is1d = selectedAprType === '1d';
    
    const sortedData = data.map(assetData => {
        // For 1d mode, only use data points that have apr_1d
        const relevantData = is1d 
            ? assetData.data.filter(d => d.apr_1d != null)
            : assetData.data.filter(d => d.apr != null);
        
        if (relevantData.length === 0) return null;
        
        const latest = relevantData[relevantData.length - 1];
        if (!latest) return null;
        
        // Get the APR value based on selected type - no fallback
        const aprValue = is1d ? latest.apr_1d : latest.apr;
        
        if (aprValue == null) return null;
        
        // Calculate 24h change using only the relevant data
        let change24h = null;
        if (relevantData.length > 1) {
            const now = new Date(latest.timestamp);
            const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
            
            let closest = relevantData[0];
            let minDiff = Math.abs(new Date(closest.timestamp) - oneDayAgo);
            
            for (let point of relevantData) {
                const diff = Math.abs(new Date(point.timestamp) - oneDayAgo);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = point;
                }
            }
            
            const closestApr = is1d ? closest.apr_1d : closest.apr;
            
            if (closestApr != null) {
                change24h = aprValue - closestApr;
            }
        }
        
        return {
            symbol: assetData.symbol,
            protocol: assetData.protocol,
            version: assetData.version,
            apr: aprValue,
            tvl_usd: latest.tvl_usd,
            change24h: change24h,
            timestamp: new Date(latest.timestamp)
        };
    }).filter(x => x !== null);
    
    window.tableData = sortedData;
    applySortToTable();
}

function applySortToTable() {
    const tbody = document.getElementById('currentAprs');
    tbody.innerHTML = '';
    
    let sorted = [...window.tableData];
    
    sorted.sort((a, b) => {
        let aVal, bVal;
        
        switch(currentSortColumn) {
            case 0:
                aVal = a.symbol;
                bVal = b.symbol;
                const cmp = aVal.localeCompare(bVal);
                return currentSortDirection === 'asc' ? cmp : -cmp;
            case 1:
                aVal = a.apr;
                bVal = b.apr;
                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            case 2:
                aVal = a.change24h ?? -Infinity;
                bVal = b.change24h ?? -Infinity;
                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            default:
                return 0;
        }
    });
    
    for (let i = 0; i < 3; i++) {
        const th = document.getElementById(`th-${i}`);
        if (th) {
            let text = th.textContent.replace(/ [‚Üë‚Üì]/g, '');
            if (i === currentSortColumn) {
                text += currentSortDirection === 'asc' ? ' ‚Üë' : ' ‚Üì';
            }
            th.textContent = text;
        }
    }
    
    sorted.forEach(item => {
        const row = document.createElement('tr');
        
        let changeHtml = '<span class="text-muted">-</span>';
        if (item.change24h !== null) {
            const changeClass = item.change24h >= 0 ? 'text-success' : 'text-danger';
            const changeSymbol = item.change24h >= 0 ? '+' : '';
            changeHtml = `<span class="${changeClass}">${changeSymbol}${item.change24h.toFixed(2)}%</span>`;
        }
        
        const timeAgo = formatTimeAgo(item.timestamp);
        const logo = protocolLogos[item.protocol] || '/static/default-logo.png';
        const versionStr = item.version ? ` ${item.version}` : '';
        
        row.innerHTML = `
            <td>
                <img src="${logo}" alt="${item.protocol}" style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle; border-radius: 4px;" onerror="this.style.display='none'">
                <strong>${item.symbol}</strong>
                <span class="text-muted" style="font-size: 0.8rem; margin-left: 5px;">${item.protocol}${versionStr}</span>
            </td>
            <td><span style="color: #4ade80; font-size: 1.1rem; font-weight: 600;">${item.apr.toFixed(2)}%</span></td>
            <td>${changeHtml}</td>
            <td class="text-secondary">${timeAgo}</td>
        `;
        tbody.appendChild(row);
    });
}

function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
}

function sortTable(columnIndex) {
    if (currentSortColumn === columnIndex) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = columnIndex;
        currentSortDirection = 'desc';
    }
    
    applySortToTable();
}

document.getElementById('timeRange').addEventListener('change', loadChart);

// APR type toggle event listeners
document.querySelectorAll('input[name="aprType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        selectedAprType = e.target.value;
        loadChart();
    });
});

loadAssets().then(() => {
    loadChart();
    // Render breakdown charts after history data is loaded
    setTimeout(renderBreakdownCharts, 500);
});

// Save Chart functionality
function saveCurrentChart() {
    {% if current_user.is_authenticated %}
    document.getElementById('chartName').value = 'Cardano LP Chart';
    new bootstrap.Modal(document.getElementById('saveChartModal')).show();
    {% else %}
    new bootstrap.Modal(document.getElementById('authModal')).show();
    {% endif %}
}

async function handleSaveChart(event) {
    event.preventDefault();
    
    const name = document.getElementById('chartName').value;
    const alert = document.getElementById('saveChartAlert');
    
    const filters = {
        chain: chain,
        days: parseInt(document.getElementById('timeRange').value),
        assets: Array.from(selectedAssets),
        yield_type: yieldType,
        apr_type: selectedAprType
    };
    
    const displayOptions = { colors: pairColorMap };
    
    try {
        const response = await fetch('/api/auth/charts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, filters, display_options: displayOptions })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert.textContent = 'Chart saved successfully!';
            alert.className = 'alert alert-success';
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('saveChartModal')).hide();
                alert.classList.add('d-none');
            }, 1500);
        } else {
            alert.textContent = data.error || 'Failed to save chart';
            alert.className = 'alert alert-danger';
            alert.classList.remove('d-none');
        }
    } catch (e) {
        alert.textContent = 'Connection error. Please try again.';
        alert.className = 'alert alert-danger';
        alert.classList.remove('d-none');
    }
}

// Breakdown pie charts
const breakdownCharts = {};
const breakdownProtocolData = {}; // Store per-protocol data for filtering

// Protocol colors - consistent across all protocols
const protocolBreakdownColors = {
    'minswap': {
        fees: '#0E8749',
        farm: '#F74B03'
    },
    'sundaeswap': {
        fees: '#0E8749',
        farm: '#F74B03'
    },
    'wingriders': {
        fees: '#0E8749',
        staking: '#06b6d4',
        farm: '#F74B03'
    }
};

function renderBreakdownCharts() {
    const container = document.getElementById('breakdownCharts');
    
    if (!allHistoryData || allHistoryData.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="breakdown-loading">
                    <span>No data available for breakdown</span>
                </div>
            </div>
        `;
        return;
    }
    
    // Group data by protocol and calculate breakdown
    const protocolBreakdowns = {};
    
    allHistoryData.forEach(assetData => {
        const protocol = assetData.protocol;
        const latestData = assetData.data[assetData.data.length - 1];
        
        if (!latestData) return;
        
        if (!protocolBreakdowns[protocol]) {
            protocolBreakdowns[protocol] = {
                protocol: protocol,
                pools: [],
                totalTvl: 0,
                totalFeeApr: 0,
                totalFarmApr: 0
            };
        }
        
        const tvl = latestData.tvl_usd || 0;
        const apr = latestData.apr || 0;      // 30-day APR (total for SundaeSwap)
        const apr1d = latestData.apr_1d || 0; // 1-day APR
        const fees24h = latestData.fees_24h || 0;
        
        let feeApr = 0;
        let farmApr = 0;
        let totalApr = 0;
        
        // Protocol-specific breakdown logic
        if (protocol === 'sundaeswap') {
            // SundaeSwap: apr_1d = HRA (fees only), apr = total (fees + SUNDAE farming)
            feeApr = apr1d;
            farmApr = Math.max(0, apr - apr1d);
            totalApr = apr;
        } else if (protocol === 'minswap') {
            // Minswap: apr_1d = total (fees + MIN farming), calculate fees from fees_24h
            if (tvl > 0 && fees24h > 0) {
                feeApr = (fees24h / tvl) * 365 * 100;
            }
            farmApr = Math.max(0, apr1d - feeApr);
            totalApr = apr1d > 0 ? apr1d : apr;
        } else if (protocol === 'wingriders') {
            // WingRiders: use stored breakdown if available, otherwise fallback
            if (latestData.fee_apr != null) {
                feeApr = latestData.fee_apr;
                farmApr = latestData.farm_apr || 0;
                totalApr = apr; // Use stored total
            } else {
                // Fallback for old data without breakdown
                feeApr = apr;
                farmApr = 0;
                totalApr = apr;
            }
        } else {
            // Default fallback
            if (tvl > 0 && fees24h > 0) {
                feeApr = (fees24h / tvl) * 365 * 100;
                farmApr = Math.max(0, (apr1d || apr) - feeApr);
            } else {
                feeApr = apr1d || apr;
                farmApr = 0;
            }
            totalApr = apr1d || apr;
        }
        
        // Track staking APR separately for WingRiders
        const stakingApr = (protocol === 'wingriders' && latestData.staking_apr != null) 
            ? latestData.staking_apr 
            : 0;
        
        // Swap fee percentage from API (e.g., 0.30 for 0.30%)
        const swapFeePercent = latestData.swap_fee_percent || null;
        
        protocolBreakdowns[protocol].pools.push({
            symbol: assetData.symbol,
            tvl: tvl,
            feeApr: feeApr,
            stakingApr: stakingApr,
            farmApr: farmApr,
            totalApr: totalApr,
            swapFeePercent: swapFeePercent
        });
        
        protocolBreakdowns[protocol].totalTvl += tvl;
    });
    
    // Calculate TVL-weighted averages for each protocol
    const protocolData = Object.values(protocolBreakdowns).map(p => {
        let weightedFeeApr = 0;
        let weightedStakingApr = 0;
        let weightedFarmApr = 0;
        
        if (p.totalTvl > 0) {
            p.pools.forEach(pool => {
                const weight = pool.tvl / p.totalTvl;
                weightedFeeApr += pool.feeApr * weight;
                weightedStakingApr += (pool.stakingApr || 0) * weight;
                weightedFarmApr += pool.farmApr * weight;
            });
        } else if (p.pools.length > 0) {
            // Simple average if no TVL data
            weightedFeeApr = p.pools.reduce((sum, pool) => sum + pool.feeApr, 0) / p.pools.length;
            weightedStakingApr = p.pools.reduce((sum, pool) => sum + (pool.stakingApr || 0), 0) / p.pools.length;
            weightedFarmApr = p.pools.reduce((sum, pool) => sum + pool.farmApr, 0) / p.pools.length;
        }
        
        // Calculate TVL-weighted average swap fee for "All Pools" display
        let weightedSwapFee = null;
        const poolsWithSwapFee = p.pools.filter(pool => pool.swapFeePercent != null);
        if (poolsWithSwapFee.length > 0) {
            const totalTvlWithFee = poolsWithSwapFee.reduce((sum, pool) => sum + pool.tvl, 0);
            if (totalTvlWithFee > 0) {
                weightedSwapFee = poolsWithSwapFee.reduce((sum, pool) => {
                    const weight = pool.tvl / totalTvlWithFee;
                    return sum + (pool.swapFeePercent * weight);
                }, 0);
            } else {
                // Simple average if no TVL data
                weightedSwapFee = poolsWithSwapFee.reduce((sum, pool) => sum + pool.swapFeePercent, 0) / poolsWithSwapFee.length;
            }
        }
        
        return {
            protocol: p.protocol,
            poolCount: p.pools.length,
            totalTvl: p.totalTvl,
            pools: p.pools, // Include pools for dropdown filter
            feeApr: weightedFeeApr,
            stakingApr: weightedStakingApr,
            farmApr: weightedFarmApr,
            totalApr: weightedFeeApr + weightedStakingApr + weightedFarmApr,
            swapFeePercent: weightedSwapFee
        };
    }).filter(p => p.totalApr > 0);
    
    if (protocolData.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="breakdown-loading">
                    <span>No breakdown data available</span>
                </div>
            </div>
        `;
        return;
    }
    
    // Store protocol data for filtering and build cards HTML
    let html = '';
    protocolData.forEach((data, index) => {
        // Store for later use
        breakdownProtocolData[index] = data;
        
        const colors = protocolBreakdownColors[data.protocol] || { fees: '#0E8749', farm: '#F74B03' };
        const logo = protocolLogos[data.protocol] || '';
        
        // Build pool options for dropdown (sorted by total APR descending)
        const sortedPools = [...data.pools].sort((a, b) => b.totalApr - a.totalApr);
        const poolOptions = sortedPools.map(p => 
            `<option value="${p.symbol}">${p.symbol} (${p.totalApr.toFixed(1)}%)</option>`
        ).join('');
        
        html += `
            <div class="col-md-4">
                <div class="breakdown-card">
                    <div class="breakdown-card-header">
                        <img src="${logo}" alt="${data.protocol}" onerror="this.style.display='none'">
                        <h5>${data.protocol}</h5>
                        <span class="breakdown-card-meta">${data.poolCount} pools</span>
                    </div>
                    <div class="breakdown-filter">
                        <select id="breakdownFilter${index}" onchange="updateBreakdownChart(${index})">
                            <option value="all">All Pools (TVL-weighted avg)</option>
                            ${poolOptions}
                        </select>
                    </div>
                    <div class="breakdown-chart-container">
                        <canvas id="breakdownChart${index}"></canvas>
                        <div class="breakdown-chart-center" id="breakdownChartCenter${index}">
                            <!-- Swap fee displayed here -->
                        </div>
                    </div>
                    <div class="breakdown-legend" id="breakdownLegend${index}">
                        <!-- Legend populated by JS -->
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Initial render of all charts with "All Pools" selected
    protocolData.forEach((data, index) => {
        updateBreakdownChart(index);
    });
}

function updateBreakdownChart(index) {
    const data = breakdownProtocolData[index];
    if (!data) return;
    
    const filterSelect = document.getElementById(`breakdownFilter${index}`);
    const selectedValue = filterSelect ? filterSelect.value : 'all';
    
    let displayData;
    
    if (selectedValue === 'all') {
        // Use TVL-weighted averages
        displayData = {
            feeApr: data.feeApr,
            stakingApr: data.stakingApr,
            farmApr: data.farmApr,
            totalApr: data.totalApr,
            swapFeePercent: data.swapFeePercent
        };
    } else {
        // Find the specific pool
        const pool = data.pools.find(p => p.symbol === selectedValue);
        if (pool) {
            displayData = {
                feeApr: pool.feeApr,
                stakingApr: pool.stakingApr || 0,
                farmApr: pool.farmApr,
                totalApr: pool.totalApr,
                swapFeePercent: pool.swapFeePercent
            };
        } else {
            displayData = { feeApr: 0, stakingApr: 0, farmApr: 0, totalApr: 0, swapFeePercent: null };
        }
    }
    
    // Update center text with swap fee
    const centerContainer = document.getElementById(`breakdownChartCenter${index}`);
    if (centerContainer) {
        if (displayData.swapFeePercent != null) {
            centerContainer.innerHTML = `
                <div class="swap-fee-label">Swap Fee</div>
                <div class="swap-fee-value">${displayData.swapFeePercent.toFixed(2)}%</div>
            `;
        } else {
            centerContainer.innerHTML = '';
        }
    }
    
    const colors = protocolBreakdownColors[data.protocol] || { fees: '#0E8749', farm: '#F74B03' };
    
    // Update legend
    const legendContainer = document.getElementById(`breakdownLegend${index}`);
    if (legendContainer) {
        const hasStaking = displayData.stakingApr > 0.01;
        const hasFarm = displayData.farmApr > 0.01;
        
        legendContainer.innerHTML = `
            <div class="breakdown-legend-item">
                <span class="breakdown-legend-color" style="background: ${colors.fees}"></span>
                <span class="breakdown-legend-label">Trading Fees</span>
                <span class="breakdown-legend-value">${displayData.feeApr.toFixed(2)}%</span>
            </div>
            ${hasStaking ? `
            <div class="breakdown-legend-item">
                <span class="breakdown-legend-color" style="background: ${colors.staking || '#06b6d4'}"></span>
                <span class="breakdown-legend-label">${data.protocol === 'wingriders' ? 'NFT Bonus' : 'ADA Staking'}</span>
                <span class="breakdown-legend-value">${displayData.stakingApr.toFixed(2)}%</span>
            </div>
            ` : ''}
            ${hasFarm ? `
            <div class="breakdown-legend-item">
                <span class="breakdown-legend-color" style="background: ${colors.farm}"></span>
                <span class="breakdown-legend-label">Farm Rewards</span>
                <span class="breakdown-legend-value">${displayData.farmApr.toFixed(2)}%</span>
            </div>
            ` : ''}
            <div class="breakdown-legend-item" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(0,0,0,0.08);">
                <span class="breakdown-legend-color" style="background: transparent"></span>
                <span class="breakdown-legend-label"><strong>Total APR</strong></span>
                <span class="breakdown-legend-value" style="color: var(--sea-green);">${displayData.totalApr.toFixed(2)}%</span>
            </div>
        `;
    }
    
    // Update chart
    const ctx = document.getElementById(`breakdownChart${index}`);
    if (!ctx) return;
    
    // Destroy existing chart if any
    if (breakdownCharts[index]) {
        breakdownCharts[index].destroy();
    }
    
    // Build chart data dynamically based on what components exist
    const chartData = [];
    const chartColors = [];
    const chartLabels = [];
    
    // Always include fees if > 0
    if (displayData.feeApr > 0.001) {
        chartData.push(displayData.feeApr);
        chartColors.push(colors.fees);
        chartLabels.push('Trading Fees');
    }
    
    // Include staking if significant (WingRiders)
    if (displayData.stakingApr > 0.01) {
        chartData.push(displayData.stakingApr);
        chartColors.push(colors.staking || '#06b6d4');
        chartLabels.push(data.protocol === 'wingriders' ? 'NFT Bonus' : 'ADA Staking');
    }
    
    // Include farm rewards if significant
    if (displayData.farmApr > 0.01) {
        chartData.push(displayData.farmApr);
        chartColors.push(colors.farm);
        chartLabels.push('Farm Rewards');
    }
    
    // Skip if no data
    if (chartData.length === 0) {
        chartData.push(1);
        chartColors.push('#e5e7eb');
        chartLabels.push('No Data');
    }
    
    breakdownCharts[index] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
                data: chartData,
                backgroundColor: chartColors,
                borderColor: 'rgba(255,255,255,0.9)',
                borderWidth: 2,
                hoverOffset: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '55%',
            plugins: {
                legend: {
                    display: false,
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.label === 'No Data') return 'No breakdown data';
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ${context.raw.toFixed(2)}% (${percentage}% of total)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 500,
                easing: 'easeOutQuart'
            }
        }
    });
}
</script>
{% endblock %}

